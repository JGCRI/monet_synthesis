---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). We will execute a set of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within KÃ¶ppen climatic zones, 3) and the spatial distribution of soil clay content (Table 1). Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013). For an upscaled comparison of soil clay content.....

## Load Packages

General data manipulation: `dplyr` and `tidyr`

Plotting: `ggplot2`

Geographic data handling: `sf`, `terra`, `raster`, `tiff`

Precipitation and Temperature data: `geodata`

```{r libraries, results = "hide", warning = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(terra)
library(raster)
library(tiff)
library(geodata)

```

# 1. Comparison of Soil Respiration relative to MAP and MAT

## Read in MONet respiration and SRDB data

Read in the experiment data and sample location files for the MONet and the SRDB soil respiration data and filter for observations in the Continental United States (CONUS)

If your data directory is missing any of the files below, download them from their respective sources into the "data" folder.

[MONet soil respiration](https://zenodo.org/records/15328215)

[SRDB](https://github.com/bpbond/srdb)

[United States shapefile](https://www.weather.gov/gis/USStates)

```{r Comparison of Soil Respiration relative to MAP and MAT, results = "hide", warning = FALSE, message = FALSE}

# read in site coordinates and data
monet_rs <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
rs_coord <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")
srdb <- read.csv("data/srdb/srdb-20250503a/srdb-data.csv")

# state codes for filtering CONUS
state_abbreviations_conus <- c(
  "AL", "AZ", "AR", "CA", "CO",
  "CT", "DE", "FL", "GA", "ID",
  "IL", "IN", "IA", "KS", "KY",
  "LA", "ME", "MD", "MA", "MI",
  "MN", "MS", "MO", "MT", "NE",
  "NV", "NH", "NJ", "NM", "NY",
  "NC", "ND", "OH", "OK", "OR",
  "PA", "RI", "SC", "SD", "TN",
  "TX", "UT", "VT", "VA", "WA",
  "WV", "WI", "WY"
)

# Read and ensure valid shapes for CONUS
conus_valid <- st_read("data/shapefiles/s_18mr25/s_18mr25.shp") %>%
  st_make_valid() %>%
  filter(STATE %in% state_abbreviations_conus) %>%
  st_transform("WGS84")

# Define the target CRS from the shapefile
target_crs <- st_crs(conus_valid)

# Disable S2 processing to use GEOS for spatial operations
sf_use_s2(FALSE)

# Filter SRDB coordinates within shapefile boundaries
SRDB_coords <- srdb %>%
  dplyr::select(Record_number, Latitude, Longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
  st_transform(target_crs) %>%
  {.[rowSums(st_within(., conus_valid, sparse = FALSE)) > 0, ]}

# Convert rs_coord to sf assuming the column names are 'Long' and 'Lat'
monet_rs_coords <- rs_coord %>%
  filter(Site_Code != "PUUM") %>% #Take out one
  st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  st_transform(target_crs)

# Plotting both sets of coordinates
ggplot() +
  geom_sf(data = conus_valid, fill = NA, color = "gray", linetype = "solid") +
  geom_sf(data = SRDB_coords, aes(color = 'SRDB Source'), size = 2, alpha = 0.7) +
  geom_sf(data = monet_rs_coords, aes(color = 'Monet RS Source'), size = 2, alpha = 0.7) +
  scale_color_manual(values = c('SRDB Source' = 'blue', 'Monet RS Source' = 'red')) +
  theme_bw() +
  labs(title = "Map of Coordinates from Two Sources",
       color = "Data Source") +
  theme(legend.position = "bottom")
```

## Extract Mean Annual Precipitation (MAP) and Mean Annual Temperature (MAT) for sample coordinates

Using the `geodata` package, \~1km\^2 gridded 10 minute precipitation and average temperature data from 1970-2000 is downloaded and and extracted at the MONet and SRDB sample sites. These data are then used to create timeseries of MAP and MAP for each sample location. A selection of sites are plotted for illustration.

```{r Extract MAP and MAT for samples, results = "hide", warning = FALSE, message = FALSE}
# Function to extract climate data: precipitation and temperature
process_climate_data <- function(coords_df, ID_column) {
  coords_extracted <- st_coordinates(coords_df)
  coords_data <- tibble(place = coords_df[[ID_column]], lon = coords_extracted[, "X"], lat = coords_extracted[, "Y"])
  coords_data$ID <- seq_len(nrow(coords_data))

  # WorldClim data extraction
  tavg <- worldclim_global("tavg", "10", "data/worldclim_data/")
  tprec <- worldclim_global("prec", "10", "data/worldclim_data/")

  tavg_extracted <- terra::extract(tavg, coords_data[, c("lon", "lat")])
  tprec_extracted <- terra::extract(tprec, coords_data[, c("lon", "lat")])

  # Calculate MAT and MAP
  coords_data <- coords_data %>%
    mutate(MAT = rowMeans(tavg_extracted[, -1], na.rm = TRUE),
           MAP = rowMeans(tprec_extracted[, -1], na.rm = TRUE) * 12) # Convert to annual precipitation

  # Reshape monthly precipitation data
  monthly_prec <- pivot_longer(tprec_extracted, -ID, names_to = "name", values_to = "precipitation")
  
  # Reshape monthly temperature data
  monthly_temp <- pivot_longer(tavg_extracted, -ID, names_to = "name", values_to = "temperature")

  monthly_prec$month <- as.numeric(gsub("wc2.1_10m_prec_", "", monthly_prec$name))
  monthly_temp$month <- as.numeric(gsub("wc2.1_10m_tavg_", "", monthly_temp$name))

  monthly_joined_prec <- monthly_prec %>% mutate(place = coords_data$place[monthly_prec$ID])
  monthly_joined_temp <- monthly_temp %>% mutate(place = coords_data$place[monthly_temp$ID])

  return(list(monthly_prec = monthly_joined_prec, monthly_temp = monthly_joined_temp, annual = coords_data))
}

# Plot function for climatology
plot_climatology <- function(monthly_data, title, y_label, value_column) {
  ggplot(monthly_data, aes(month, !!sym(value_column), color = factor(place))) +
    geom_line() +
    ylab(y_label) +
    ggtitle(title) +
    theme_bw() +
    theme(legend.position = "bottom")
}

# Process monet_rs_coords, subset 18 and plot
monet_data <- process_climate_data(monet_rs_coords, "Site_Code")
set.seed(42)
sampled_places_monet <- monet_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_monet <- monet_data$monthly_prec %>% filter(place %in% sampled_places_monet$place)
sampled_temp_monet <- monet_data$monthly_temp %>% filter(place %in% sampled_places_monet$place)

p_monet_prec <- plot_climatology(sampled_prec_monet, "Precipitation for Sampled Monet RS Coords", "Precipitation", "precipitation")
p_monet_temp <- plot_climatology(sampled_temp_monet, "Temperature for Sampled Monet RS Coords", "Air temperature", "temperature")
print(p_monet_prec)
print(p_monet_temp)

# Process SRDB_coords, subset 18 and plot
srdb_data <- process_climate_data(SRDB_coords, "Record_number")
set.seed(42)
sampled_places_srdb <- srdb_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_srdb <- srdb_data$monthly_prec %>% filter(place %in% sampled_places_srdb$place)
sampled_temp_srdb <- srdb_data$monthly_temp %>% filter(place %in% sampled_places_srdb$place)

p_srdb_prec <- plot_climatology(sampled_prec_srdb, "Precipitation for Sampled SRDB Coords", "Precipitation", "precipitation")
p_srdb_temp <- plot_climatology(sampled_temp_srdb, "Temperature for Sampled SRDB Coords", "Air temperature", "temperature")
print(p_srdb_prec)
print(p_srdb_temp)

# Final annual dataframe
print("Annual data for Monet RS Coords")
head(monet_data$annual)
print("Annual data for SRDB Coords")
head(srdb_data$annual)
```

## Identify relationship between soil respiration in SRDB to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on annual soil respiration.

```{r SRDB MAP and MAT relationship}

# Select annual respiration from SRDB dadta
srdb %>%
  dplyr::select(Rs_annual, Record_number) -> srdb_slim

# Rename the 'place' column in srdb_data$annual to match 'Record_number' in srdb_slim
srdb_annual <- srdb_data$annual %>%
  rename(Record_number = place)

# Combine datasets by 'Record_number'
combined_data <- srdb_slim %>%
  inner_join(srdb_annual, by = "Record_number")

# Inspect the combined data
head(combined_data)

# Linear regression model to test the effect of MAP and MAT on Rs_annual
model <- lm(Rs_annual ~ MAP + MAT, data = combined_data)
summary(model)

# Print regression summary
print(summary(model))

# Plot Rs_annual vs MAP
plot_MAP <- ggplot(combined_data, aes(x = MAP, y = Rs_annual)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Effect of MAP on Rs_annual",
       x = "Mean Annual Precipitation (MAP)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()

# Plot Rs_annual vs MAT
plot_MAT <- ggplot(combined_data, aes(x = MAT, y = Rs_annual)) +
  geom_point() +
  geom_smooth(method = "lm", col = "red") +
  labs(title = "Effect of MAT on Rs_annual",
       x = "Mean Annual Temperature (MAT)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()

# Display the plots
print(plot_MAP)
print(plot_MAT)

```

## Identify relationship between soil respiration in MONet to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on annual soil respiration.

```{r MONet MAP and MAT respiration relationship}

# Select soil respiration from MONet data
monet_rs %>%
  dplyr::select(Sample_Name, respiration_ppm_co2_c,
         respiration_mg_co2_c_g_soil_day_24hour,
         respiration_mg_co2_c_g_soil_day_96hour) -> monet_slim

# Function to separate and add metadata from Sample_Name
extract_metadata <- function(monet_slim) {
  monet_slim %>%
    mutate(
      Site_Code = sapply(strsplit(Sample_Name, "_"), `[`, 3),
      Core_Section = sapply(strsplit(Sample_Name, "_"), `[`, 4)
    )
}

# Extract metadata
monet_rs_metadata <- extract_metadata(monet_slim)

# Integrate this with the annual climate data (MAT, MAP) using Site_Code as key
combined_monet <- monet_rs_metadata %>%
  inner_join(monet_data$annual, by = c("Site_Code" = "place"))

# Compute linear models and summarize using select() inside group_by
lm_models <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_ppm_co2_c ~ MAT, data = dplyr::select(., MAT, respiration_ppm_co2_c))),
    model_MAP = list(lm(respiration_ppm_co2_c ~ MAP, data = dplyr::select(., MAP, respiration_ppm_co2_c)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models)) {
  cat("Core Section: ", lm_models$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting Rs_annual vs MAT and MAP for each Core_Section separately
# Change 'Rs_annual' column as necessary to match the respiration data you are plotting

p_monet_MAT_core <- ggplot(combined_monet, aes(x = MAT, y = respiration_ppm_co2_c, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

p_monet_MAP_core <- ggplot(combined_monet, aes(x = MAP, y = respiration_ppm_co2_c, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

print(p_monet_MAT_core)
print(p_monet_MAP_core)

```

## Identify relationship between mg C-CO2 per 24 soil respiration in MONet to MAP and MAT

```{r MONet 24h respiration}

# Compute linear models and summarize using select() inside group_by
lm_models_24h <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_mg_co2_c_g_soil_day_24hour ~ MAT, data = dplyr::select(., MAT, respiration_mg_co2_c_g_soil_day_24hour))),
    model_MAP = list(lm(respiration_mg_co2_c_g_soil_day_24hour ~ MAP, data = dplyr::select(., MAP, respiration_mg_co2_c_g_soil_day_24hour)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models_24h)) {
  cat("Core Section: ", lm_models_24h$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models_24h$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models_24h$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting 24h respiration vs MAT and MAP for each Core_Section separately

p_monet_MAT_core_24h <- ggplot(combined_monet, aes(x = MAT, y = respiration_mg_co2_c_g_soil_day_24hour, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on 24h Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")+
  xlim(8,16)

p_monet_MAP_core_24h <- ggplot(combined_monet, aes(x = MAP, y = respiration_mg_co2_c_g_soil_day_24hour, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on 24h Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

print(p_monet_MAT_core_24h)
print(p_monet_MAP_core_24h)
```

## Identify relationship between mg C-CO2 per 96h soil respiration in MONet to MAP and MAT

```{r MONet 96h respiration}

# Compute linear models and summarize using select() inside group_by
lm_models_96h <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_mg_co2_c_g_soil_day_96hour ~ MAT, data = dplyr::select(., MAT, respiration_mg_co2_c_g_soil_day_96hour))),
    model_MAP = list(lm(respiration_mg_co2_c_g_soil_day_96hour ~ MAP, data = dplyr::select(., MAP, respiration_mg_co2_c_g_soil_day_96hour)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models_96h)) {
  cat("Core Section: ", lm_models_96h$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models_96h$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models_96h$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting 96h respiration vs MAT and MAP for each Core_Section separately

p_monet_MAT_core_96h <- ggplot(combined_monet, aes(x = MAT, y = respiration_mg_co2_c_g_soil_day_96hour, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on 96h Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")+
  xlim(8,16)

p_monet_MAP_core_96h <- ggplot(combined_monet, aes(x = MAP, y = respiration_mg_co2_c_g_soil_day_96hour, color = Core_Section)) +
  geom_point() +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on 96h Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

print(p_monet_MAT_core_96h)
print(p_monet_MAP_core_96h)
```

# pH and Clay Comparison between MONet and Soilgrids

## Reading pH and clay data from MONet and 1000 soils database

Read in the experiment data and sample location files for the pH and clay data from MONet and the 1000 soil database. If your data directory is missing any of the files below, download them from their respective sources put into the "data" folder.

[MONet](https://sc-data.emsl.pnnl.gov/monet)

[1000 soils](https://zenodo.org/records/15328215)

```{r read in MONet data}

# read in site coordinates
monet_pH_coord <- read.csv("data/MONet/pH/processed_data/Coordinates.csv")
monet_clay_coord <- read.csv("data/MONet/clay/processed_data/Coordinates.csv")

# read in site data
monet_pH_data <- read.csv("data/MONet/pH/processed_data/Soil_BioChemical_properties.csv")
monet_clay_data <- read.csv("data/MONet/clay/processed_data/Soil_BioChemical_properties.csv")

# read in 1000soil sample data
processed_1000s <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
metadata_1000s <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")

```

## Join pH and clay site locations to data and combine MONet and 1000 soils

For the MONet soil data we join the sample data, to the sample coordinates using the proposal ID and sample number of the associated data. The data from the 1000 soils experiment is joined in a similar fashion, however, only the site code is used to join the data.

MONet and 1000 soils data are then manipulated and joined to create the measured pH and Clay data.

```{r Join data, echo=FALSE, warning=FALSE, message=FALSE}

# Join MONet pH sample data and location
monet_pH_loc <- monet_pH_data%>%
  # Separate the Sample_Name column into distict columns
  separate(Sample_Name, into = c("proposal_id", "sample", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sample = as.numeric(sample))%>%
  # Join to the coordinated by proposal ID and sample set
  left_join(monet_pH_coord, by = c("proposal_id", "sample" = "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sample = as.character(sample))%>%
  dplyr::select(proposal_id, sample, core_section, pH, latitude, longitude)%>%
  mutate(source = "MONet")

# Join MONet clay content sample data and location
monet_clay_loc <- monet_clay_data%>%
  # Separate the Sample_Name column into distict columns
  separate(Sample_Name, into = c("proposal_id", "sample", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sample = as.numeric(sample))%>%
  left_join(monet_clay_coord, by = c("proposal_id", "sample" = "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sample = as.character(sample))%>%
  dplyr::select(proposal_id, sample, core_section, Clay_percent, latitude, longitude)%>%
  mutate(source = "MONet")

# Join 1000 soil sample data and location
processed_1000s_loc <- processed_1000s%>%
  separate(Sampling_Set, into = c("prj", "Site_Code"))%>%
  left_join(metadata_1000s, by = c("Site_Code"))%>%
  filter(!is.na(Lat))%>%
  # format to MONet structure
  dplyr::select(proposal_id = Proposal_ID, sample = prj, 
                core_section = Core_Section, pH, Clay_percent, 
                latitude = Lat, longitude = Long)%>%
  mutate(source = "1000s")

# Bind MONet data with 1000s clay and pH data
monet_pH <- bind_rows(monet_pH_loc, dplyr::select(processed_1000s_loc, -Clay_percent))

monet_clay <- bind_rows(monet_clay_loc, dplyr::select(processed_1000s_loc, -pH))

```

## Extract Koppen Climate Zones for MONet data

This section walks through the steps of loading a shapefile of the Koppen climate zones of North America, filtering the shapefile to CONUS, and extracting the climate region for each data site location in the MONet and 1000 soils experiments.

If your data directory is missing any of the files below, download them from their respective sources put into the "data" folder.

[North American Koppen Climate Zones](https://www.cec.org/north-american-environmental-atlas/climate-zones-of-north-america)

## Load in North American Climate Zones and CONUS Shapefile

```{r load climate, echo=FALSE, warning=FALSE, message=FALSE}
# Load the shapefile as an `sf` object
climate_zones_sf <- st_read("data/shapefiles/na_climatezones_shapefile/climatezones_shapefile/NA_ClimateZones/data/North_America_Climate_Zones.shp")%>%
  st_transform(crs(conus_valid))

# Create a mapping table for the 3 letter climate zone code to the full name
climate_zone_mapping <- climate_zones_sf%>%
  distinct(Code, Climate)

# Read in United States shapefile, transform to climate zone projection and filter to CONUS
#TODO remove
# CONUS_sf <- st_read("data/shapefiles/s_18mr25/s_18mr25.shp")%>%
#   st_transform(st_crs(climate_zones_sf))%>%
#   filter(STATE %in% state_abbreviations_conus)

# Find intersection of climate zones and CONUS
climate_zones_conus_sf <- climate_zones_sf%>%
  st_intersection(st_union(conus_valid))

ggplot() +
  geom_sf(data = climate_zones_conus_sf, aes(fill = Climate), color = "black", alpha = 0.5) +
  geom_sf(data = conus_valid, color = "red", alpha = 0.3)+
  #geom_sf(data = pH_loc_sf)+
  labs(title = "CONUS Koppen Climate Zones") +
  theme(legend.position = "none")

```

## Convert MONet data points to `sf` objects and extract Koppen climate zone information

Convert MONet pH and clay content data tables to sf objects using the sf package. \~something about how we know that these points were collected using the basic WGS84 projection. Then transform the projection to the same as the climate zone shapefile.

Once the pH and clay data from MONet and 1000 soils are shapefile point data types, use st_join from the sf library to get the climate zone sample site.

```{r convert to sf }

# Transform pH data to WGS1984 point data then transform to climate zone projection
pH_loc_sf <- st_as_sf(monet_pH, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf)) # transform the projection to koppen zone projection

# Transform clay data to WGS1984 point data then transform to climate zone projection
clay_loc_sf <- st_as_sf(monet_clay, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf))

# Join point data to Koppen shapefile to extract region information for each point
pH_zones <- st_join(pH_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sample, core_section, pH, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

clay_zones <- st_join(clay_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sample, core_section, Clay_percent, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

```

# 2. Assessemnt of pH within Koppen Climate Zones

## Plot distribution of characteristics in each region

```{r plot pH and clay}
pH_zones%>%
  ggplot()+
  geom_boxplot(aes(x = pH, y = Climate, color = source))+
  #geom_point(aes(x = pH, y = Climate, color = source), alpha = 0.3, position = "jitter")+
  ggtitle("MONet and 1000 soils pH distributiton by climate zone")+
  theme_bw()

clay_zones%>%
  ggplot()+
  geom_boxplot(aes(x = Clay_percent, y = Climate, color = source))+
  #geom_point(aes(x = Clay_percent, y = Climate, color = source), alpha = 0.5, position = "jitter")+
  ggtitle("MONet and 1000 soils Clay content by climate zone")+
  theme_bw()
```

## Sites and samples by state

```{r samples by state, echo=FALSE, warning=FALSE, message=FALSE}
# pH_zones%>%
#   st_join(CONUS_sf)%>%
#   group_by(NAME)%>%
#   dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sample))%>%
#   arrange(desc(n_proposals), desc(n_samples))
# 
# clay_zones%>%
#   st_join(CONUS_sf)%>%
#   group_by(NAME)%>%
#   dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sample))%>%
#   arrange(desc(n_proposals), desc(n_samples))
# 

```

# Read in soilGrids clay content data and clip to CONUS


```{r soilGrids data, echo=FALSE, warning=FALSE, message=FALSE}

#TODO change processing and add in other soil levels 


# if soilgrid data has already been processed and saved to .RData, load in RData
if(!"sg_data.RData" %in% list.files()){
  
  sg_clay <- rast("./data/soilgrids/crop_roi_igh_clay.tif")
  sg_pH <- rast("./data/soilgrids/crop_roi_igh_ph.tif")
  
  plot(sg_clay)
  
  # This step takes a long time
  sg_clay_prj <- sg_clay%>%
    project(crs(climate_zones_sf))
  
  sg_pH_prj <- sg_pH%>%
    project(crs(climate_zones_sf))
  
  
  #TODO slow step
  
  # Extracts soilgrids clay and pH data from the MONet site locations
  sg_clay_monet <- terra::extract(sg_clay_prj, clay_loc_sf, fun=mean, na.rm=TRUE, bind=TRUE)
  sg_clay_monet_values <- values(sg_clay_monet)
  
  sg_pH_monet <- terra::extract(sg_pH_prj, clay_loc_sf, fun=mean, na.rm=TRUE, bind=TRUE)
  sg_pH_monet_values <- values(sg_pH_monet)
  
  
  
  sg_by_zone <- terra::extract(sg_clay_prj,climate_zones_conus_sf,fun ="table",  na.rm=TRUE, bind=TRUE)
  sg_caly <- values(sg_by_zone)
  
  sg_by_zone_clay <- sg_by_zone%>%filter(!is.na(crop_roi_igh_clay))
  
  
  
  
  sg_clay_conus <- raster::mask(sg_clay_prj, CONUS_sf)%>%project(crs(clay_loc_sf))
  
  sg_pH_conus <- raster::mask(sg_pH_prj, CONUS_sf)%>%project(crs(clay_loc_sf))
  
  plot(sg_clay_conus)
  
  
  
  
  # Convert sf to SpatVector
climate_vect <- vect(climate_zones_conus_sf)

# Get cell centers as points
clay_points <- as.points(sg_clay_prj, values = TRUE, na.rm = TRUE)

# Extract climate zone attributes
climate_extracted <- extract(climate_vect, clay_points)

# Combine results
final_result <- cbind(
  as.data.frame(clay_points, geom = "XY"),
  climate_extracted[, -1] # Remove the ID column
)
  
  
  
  
  
  
  
  
  soilgrids_by_zone <- function(soilgrids, climate_zones_conus_sf){
    
    # Convert the sf object (climate zones) to a terra SpatVector
    climate_zones_vect <- vect(climate_zones_conus_sf)
  
    # Mask clay content raster by each climate zone
    var_by_zone <- list()  # Create a list to store masked rasters for each zone
    
    climate_zone_names <- unique(climate_zones_conus_sf$Code)[1:21] 
    
    for (zone_name in climate_zone_names) {
      # Filter the specific climate zone
      single_zone <- climate_zones_vect[climate_zones_conus_sf$Code == zone_name, ]
      # Mask clay content to just this zone
      var_zone <- mask(crop(soilgrids, single_zone), single_zone)
      # Save the clay raster for this zone
      var_by_zone[[zone_name]] <- var_zone
    }
    
    # Create a list to store distinct clay content values for each zone
    values_by_zone <- list()
    
    for (zone_name in climate_zone_names) {
      # Get the clay content raster for this zone
      var_zone <- var_by_zone[[zone_name]]
      # Extract cell values as a vector
      var_values <- unique(values(var_zone, na.rm = TRUE))  # Remove NA values
      values_by_zone[[zone_name]] <- var_values         # Store in list
    }
    
    #TODO very slow ~few minutes
    var_zone_df <- data.frame(
      zone = names(values_by_zone),
      value = sapply(values_by_zone, function(x) paste(x, collapse = ", "))
    )
    
    var_long <- do.call(rbind, lapply(names(values_by_zone), function(zone_name) {
      data.frame(zone = zone_name, value = values_by_zone[[zone_name]])
    }))
    
    return(var_long)
  }
  
  clay_long <- soilgrids_by_zone(sg_clay_conus, climate_zones_conus_sf)
  
  pH_long <- soilgrids_by_zone(sg_pH_conus, climate_zones_conus_sf)
  
  save(clay_long, pH_long, file = "sg_data.RData")
} else {
  
  load("sg_data.RData")
  
}

```

```{r bind data, echo=FALSE, warning=FALSE, message=FALSE}

clay_content_MONet <- clay_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "MONet")

clay_content_sg <- clay_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(clay_content_MONet$Climate))%>%
  rename(Clay_percent = "crop_roi_igh_clay")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "soilGrids",
         Clay_percent = Clay_percent/10)

clay_MONet_sg <- bind_rows(clay_content_MONet, clay_content_sg)

pH_content_MONet <- pH_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "MONet")

pH_content_sg <- pH_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(pH_content_MONet$Climate))%>%
  rename(pH = "crop_roi_igh_ph")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "soilGrids",
         pH = pH/10)

pH_MONet_sg <- bind_rows(pH_content_MONet, pH_content_sg)

```

## Compare distributions of Clay and pH bewteen MONet and Soilgrids in aggregate and across climate zones

```{r plot comparisons}
# Boxplots of MONet and Soilgrids comparison by climate region
ggplot(data = clay_MONet_sg, aes(x = Clay_percent, y = Climate, color = source))+
  geom_violin()+
  theme_bw()+
  ggtitle("Percent Clay across Climate Zones in MONet and Soilgrids")+
  xlab("Percent Clay")+ylab("Climate Zone")

ggplot(data = pH_MONet_sg, aes(x = pH, y = Climate, color = source))+
  geom_boxplot()+
  theme_bw()+
  ggtitle("pH across Climate Zones in MONet and Soilgrids")+
  xlab("pH")+ylab("Climate Zone")

ggplot(clay_MONet_sg, aes(x = Clay_percent, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  ggtitle("Soilgrids and MONet Clay Share Distribution")

ggplot(pH_MONet_sg, aes(x = pH, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  ggtitle("Soilgrids and MONet pH distribution")

ggplot(clay_MONet_sg, aes(x = Clay_percent, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  facet_wrap(~Climate)+
  ggtitle("Soilgrids and MONet Clay Share Distribution by Climate Zone")

ggplot(pH_MONet_sg, aes(x = pH, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  facet_wrap(~Climate, scale = "free_y")+
  ggtitle("Soilgrids and MONet pH Distribution by Climate Zone")

```
```{r}

```

