---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). We will execute a set of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within KÃ¶ppen climatic zones, 3) and the spatial distribution of soil clay content (Table 1). Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013). For an upscaled comparison of soil clay content,

```{r libraries, results = "hide", warning=FALSE,message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(terra)
library(raster)
library(tiff)

```

## Reading pH and Clay content data from MONet

```{r read in MONet data}

# read in site coordinates
monet_pH_coord <- read.csv("data/MONet/pH/processed_data/Coordinates.csv")
monet_clay_coord <- read.csv("data/MONet/clay/processed_data/Coordinates.csv")

# read in site data
monet_pH_data <- read.csv("data/MONet/pH/processed_data/Soil_BioChemical_properties.csv")
monet_clay_data <- read.csv("data/MONet/clay/processed_data/Soil_BioChemical_properties.csv")

# read in 1000soil sample data
processed_1000s <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
metadata_1000s <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")

```


## Join pH and Clay site locations to data

```{r, echo=FALSE, warning=FALSE, message=FALSE}

monet_pH_loc <- monet_pH_data%>%
  separate(Sample_Name, into = c("proposal_id", "sampling_set", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sampling_set = as.numeric(sampling_set))%>%
  left_join(monet_pH_coord, by = c("proposal_id", "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sampling_set = as.character(sampling_set))%>%
  dplyr::select(proposal_id, sampling_set, core_section, pH, latitude, longitude)%>%
  mutate(source = "MONet")

monet_clay_loc <- monet_clay_data%>%
  separate(Sample_Name, into = c("proposal_id", "sampling_set", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sampling_set = as.numeric(sampling_set))%>%
  left_join(monet_clay_coord, by = c("proposal_id", "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sampling_set = as.character(sampling_set))%>%
  dplyr::select(proposal_id, sampling_set, core_section, Clay_percent, latitude, longitude)%>%
  mutate(source = "MONet")

processed_1000s_loc <- processed_1000s%>%
  separate(Sampling_Set, into = c("prj", "Site_Code"))%>%
  left_join(metadata_1000s, by = c("Site_Code"))%>%
  filter(!is.na(Lat))%>%
  dplyr::select(proposal_id = Proposal_ID, sampling_set = prj, 
                core_section = Core_Section, pH, Clay_percent, 
                latitude = Lat, longitude = Long)%>%
  mutate(source = "1000s")

# Bind MONet data with 1000s clay and pH data
monet_pH <- bind_rows(monet_pH_loc, dplyr::select(processed_1000s_loc, -Clay_percent))

monet_clay <- bind_rows(monet_clay_loc, dplyr::select(processed_1000s_loc, -pH))

```

## Join MONet data with Koppen Zones
Extract Koppen climate zones for each MONet sample for comparision across climates regions

# Load in climate zone shapefile
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load the shapefile as an `sf` object
climate_zones_sf <- st_read("data/shapefiles/na_climatezones_shapefile/climatezones_shapefile/NA_ClimateZones/data/North_America_Climate_Zones.shp")%>%
  transform("WGS84")

state_abbreviations_conus <- c(
  "AL", "AZ", "AR", "CA", "CO", 
  "CT", "DE", "FL", "GA", "ID", 
  "IL", "IN", "IA", "KS", "KY", 
  "LA", "ME", "MD", "MA", "MI", 
  "MN", "MS", "MO", "MT", "NE", 
  "NV", "NH", "NJ", "NM", "NY", 
  "NC", "ND", "OH", "OK", "OR", 
  "PA", "RI", "SC", "SD", "TN", 
  "TX", "UT", "VT", "VA", "WA", 
  "WV", "WI", "WY"
)

climate_zone_mapping <- climate_zones_sf%>%
  distinct(Code, Climate)

CONUS_sf <- st_read("data/shapefiles/s_18mr25/s_18mr25.shp")%>%
  st_transform(st_crs(climate_zones_sf))%>%
  filter(STATE %in% state_abbreviations_conus)

```

# Convert points to an `sf` object and extract Koppen region information

```{r}

climate_zones_conus_sf <- climate_zones_sf%>%
  st_intersection(st_union(CONUS_sf))

ggplot() +
  geom_sf(data = climate_zones_conus_sf, aes(fill = Climate), color = "black", alpha = 0.5) +
  geom_sf(data = CONUS_sf, color = "red", alpha = 0.3)+
  #geom_sf(data = pH_loc_sf)+
  labs(title = "Koppen Climate Zones cropped to CONUS") +
  theme(legend.position = "none")

pH_loc_sf <- st_as_sf(monet_pH, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf)) # transform the projection to koppen zone projection

clay_loc_sf <- st_as_sf(monet_clay, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf))

# Join point data to Koppen shapefile to extract region information for each point
pH_zones <- st_join(pH_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sampling_set, core_section, pH, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

clay_zones <- st_join(clay_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sampling_set, core_section, Clay_percent, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

```
  
# Plot distribution of characteristics in each region
```{r}
pH_zones%>%
  ggplot()+
  geom_boxplot(aes(x = pH, y = Climate))+
  geom_point(aes(x = pH, y = Climate, color = source), alpha = 0.5, position = "jitter")+
  ggtitle("MONet pH distributiton by climate zone")+
  theme_bw()

clay_zones%>%
  ggplot()+
  geom_boxplot(aes(x = Clay_percent, y = Climate))+
  geom_point(aes(x = Clay_percent, y = Climate, color = source), alpha = 0.5, position = "jitter")+
  ggtitle("MONet Clay content by climate zone")+
  theme_bw()
```
# Sites and samples by state
```{r, echo=FALSE, warning=FALSE, message=FALSE}
pH_zones%>%
  st_join(CONUS_sf)%>%
  group_by(NAME)%>%
  dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sampling_set))%>%
  arrange(desc(n_proposals), desc(n_samples))

clay_zones%>%
  st_join(CONUS_sf)%>%
  group_by(NAME)%>%
  dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sampling_set))%>%
  arrange(desc(n_proposals), desc(n_samples))


```

# Read in soilGrids clay content data and clip to CONUS

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# if soilgrid data has already been processed and saved to .RData, load in RData
if(!"sg_data.RData" %in% list.files()){
  
  sg_clay <- rast("./data/soilgrids/crop_roi_igh_clay.tif")
  sg_pH <- rast("./data/soilgrids/crop_roi_igh_ph.tif")
  
  plot(sg_clay)
  
  # This step takes a long time
  sg_clay_prj <- sg_clay%>%
    project(crs(climate_zones_sf))
  
  sg_pH_prj <- sg_pH%>%
    project(crs(climate_zones_sf))
  
  
  #TODO slow step
  sg_clay_conus <- raster::mask(sg_clay_prj, CONUS_sf)%>%project(crs(clay_loc_sf))
  
  sg_pH_conus <- raster::mask(sg_pH_prj, CONUS_sf)%>%project(crs(clay_loc_sf))
  
  plot(sg_clay_conus)
  
  
  soilgrids_by_zone <- function(soilgrids, climate_zones_conus_sf){
    
    # Convert the sf object (climate zones) to a terra SpatVector
    climate_zones_vect <- vect(climate_zones_conus_sf)
  
    # Mask clay content raster by each climate zone
    var_by_zone <- list()  # Create a list to store masked rasters for each zone
    
    climate_zone_names <- unique(climate_zones_conus_sf$Code)[1:21] 
    
    for (zone_name in climate_zone_names) {
      # Filter the specific climate zone
      single_zone <- climate_zones_vect[climate_zones_conus_sf$Code == zone_name, ]
      # Mask clay content to just this zone
      var_zone <- mask(crop(soilgrids, single_zone), single_zone)
      # Save the clay raster for this zone
      var_by_zone[[zone_name]] <- var_zone
    }
    
    # Create a list to store distinct clay content values for each zone
    values_by_zone <- list()
    
    for (zone_name in climate_zone_names) {
      # Get the clay content raster for this zone
      var_zone <- var_by_zone[[zone_name]]
      # Extract cell values as a vector
      var_values <- unique(values(var_zone, na.rm = TRUE))  # Remove NA values
      values_by_zone[[zone_name]] <- var_values         # Store in list
    }
    
    #TODO very slow ~few minutes
    var_zone_df <- data.frame(
      zone = names(values_by_zone),
      value = sapply(values_by_zone, function(x) paste(x, collapse = ", "))
    )
    
    var_long <- do.call(rbind, lapply(names(values_by_zone), function(zone_name) {
      data.frame(zone = zone_name, value = values_by_zone[[zone_name]])
    }))
    
    return(var_long)
  }
  
  clay_long <- soilgrids_by_zone(sg_clay_conus, climate_zones_conus_sf)
  
  pH_long <- soilgrids_by_zone(sg_pH_conus, climate_zones_conus_sf)
  
  save(clay_long, pH_long, file = "sg_data.RData")
} else {
  
  load("sg_data.RData")
  
}

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

clay_content_MONet <- clay_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "MONet")

clay_content_sg <- clay_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(clay_content_MONet$Climate))%>%
  rename(Clay_percent = "crop_roi_igh_clay")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "soilGrids",
         Clay_percent = Clay_percent/10)

clay_MONet_sg <- bind_rows(clay_content_MONet, clay_content_sg)

pH_content_MONet <- pH_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "MONet")

pH_content_sg <- pH_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(pH_content_MONet$Climate))%>%
  rename(pH = "crop_roi_igh_ph")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "soilGrids",
         pH = pH/10)

pH_MONet_sg <- bind_rows(pH_content_MONet, pH_content_sg)

```

# Compare distributions of Clay and pH bewteen MONet and Soilgrids in aggregate and across climate zones

```{r}
# Boxplots of MONet and Soilgrids comparison by climate region
ggplot(data = clay_MONet_sg, aes(x = Clay_percent, y = Climate, color = source))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "Percent Clay", y = "Climate Zone", title = "Percent Clay across Climate Zones in MONet and Soilgrids")

ggplot(data = pH_MONet_sg, aes(x = pH, y = Climate, color = source))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "pH", y = "Climate Zone", title = "pH across Climate Zones in MONet and Soilgrids")

ggplot(clay_MONet_sg, aes(x = Clay_percent, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  ggtitle("Soilgrids and MONet Clay Share Distribution")

ggplot(pH_MONet_sg, aes(x = pH, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  ggtitle("Soilgrids and MONet pH distribution")

ggplot(clay_MONet_sg, aes(x = Clay_percent, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  facet_wrap(~Climate)+
  ggtitle("Soilgrids and MONet Clay Share Distribution by Climate Zone")

ggplot(pH_MONet_sg, aes(x = pH, fill = source))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.5)+
  theme_bw()+
  facet_wrap(~Climate, scale = "free_y")+
  ggtitle("Soilgrids and MONet pH Distribution by Climate Zone")

```
















