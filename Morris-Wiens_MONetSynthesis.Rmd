---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris & Nathan J. Wiens"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    code_folding: hide
   # number_sections: TRUE
  pdf_document: 
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,           # Show code in output
  warning = FALSE,       # Hide warning messages
  message = FALSE,       # Hide package loading messages
  fig.width = 6,         # Default figure width
  fig.height = 6,        # Default figure height
  fig.align = "center"
)
```

# Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). This script executes a series of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within Köppen climatic zones and directly to SoilGrids, 3) and the spatial distribution of soil clay content. Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013).

## Prep our R Environment

### Load Packages

General data manipulation: `dplyr` and `tidyr`

Plotting: `ggplot2`, `ggpubr`, `ggpmisc`

Geographic data handling: `sf`, `terra`, `tidyterra`, `raster`, `tiff`

Precipitation and Temperature data: `geodata`

```{r libraries, results = "hide"}

library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggpmisc)
library(sf)
library(terra)
library(tidyterra)
library(raster)
library(tiff)
library(geodata)

sf_use_s2(FALSE)

```


```{r figure colors, results = "hide"}

# Set up color palette for plotting. MONet in shades of blue and various comparisons in oranges

myColors <- c( "#000080","#4040A0","#8080C0", "#D6AA80", "#D98040", "#CC5500")

names(myColors) <- c("MONet_resp", "MONet_pH", "MONet_clay",
                     "comp_clay", "comp_pH", "comp_resp")

```

### Load Pre-processed Data 1 of 3 (this can take a few minutes)

```{r Rs data, warning=FALSE, message=FALSE}

if(!"processed_Rs.RData" %in% list.files("R_data/")){
    print("Generate processed Rs data by sourcing MONetDataPreprocessing.R")
} else {
  
    load("R_data/processed_Rs.RData")

    print("Rs loaded, cheers!")
  }

```

### Load Pre-processed Data 2 of 3 (ditto)

```{r clay data, warning=FALSE, message=FALSE}

if(!"processed_clay.RData" %in% list.files("R_data/")){
  
  print("Generate processed clay data by sourcing MONetDataPreprocessing.R")
 
} else {
  
  load("R_data/processed_clay.RData")

  print("Clay data loaded, cheers!")
}


```

### Load Pre-processed Data 3 of 3 (ditto)

```{r pH data, warning=FALSE, message=FALSE}


if(!"processed_pH.RData" %in% list.files("R_data/")){
  
  print("Generate processed pH data by sourcing MONetDataPreprocessing.R")
 
} else {
  
  load("R_data/processed_pH.RData")

  print("pH data loaded, cheers!")
}

```

# 1. Examining Soil Respiration relative to Mean Annual Precipitation and Mean Annual Temperature

Soil respiration (Rs) captures aspects of biological activity in soil over variable time scales. It serves as a critical indicator for microbial processes and carbon fluxes influenced by both environmental gradients and molecular-scale interactions. Soil pH, acts as a proxy for biochemical interactions, particularly with abiotic factors such as soil mineralogy. As a fundamental property of soil chemistry, it provides valuable context for interpreting molecular observations. Clay content is included to represent soil's geological weathering and its impact on structure, water retention, and molecular adsorption. 

This section compares soil respiration measurements from MONet to the Soil Respiration Database (SRDB v5; Jian et al., 2021) and its associated gridded global \~1km\^2 resolution product (Stell et al., 2021). 

SRDB currently includes a significantly larger number of study sites across the United States compared to MONet. However, MONet is ongoing and this analysis can act as a guide for future sampling calls in order to increase sample representation across regions and soil characteristics. 

![SRDB and MONet Rs Sample Sites](./figures/srdb_MONet_conus_sites.png)

### Extract Mean Annual Precipitation (MAP) and Mean Annual Temperature (MAT) for sample coordinates

Using the `geodata` package, \~1km\^2 gridded 10 minute precipitation and average temperature data from 1970-2000 is downloaded and and extracted at the MONet and SRDB sample sites. These data are then used to create timeseries of MAP and MAP for each sample location. A selection of sites are plotted for illustration.

```{r Extract MAP and MAT for samples, cache = TRUE, echo = FALSE}

# Function to extract climate data: precipitation and temperature
process_climate_data <- function(coords_df, ID_column) {
  coords_extracted <- st_coordinates(coords_df)
  coords_data <- tibble(place = coords_df[[ID_column]], lon = coords_extracted[, "X"], lat = coords_extracted[, "Y"])
  coords_data$ID <- seq_len(nrow(coords_data))

  # WorldClim data extraction
  tavg <- worldclim_global("tavg", "10", "data/worldclim_data/")
  tprec <- worldclim_global("prec", "10", "data/worldclim_data/")

  tavg_extracted <- terra::extract(tavg, coords_data[, c("lon", "lat")])
  tprec_extracted <- terra::extract(tprec, coords_data[, c("lon", "lat")])

  # Calculate MAT and MAP
  coords_data <- coords_data %>%
    mutate(MAT = rowMeans(tavg_extracted[, -1], na.rm = TRUE),
           MAP = rowMeans(tprec_extracted[, -1], na.rm = TRUE) * 12) # Convert to annual precipitation

  # Reshape monthly precipitation data
  monthly_prec <- pivot_longer(tprec_extracted, -ID, names_to = "name", values_to = "precipitation")
  
  # Reshape monthly temperature data
  monthly_temp <- pivot_longer(tavg_extracted, -ID, names_to = "name", values_to = "temperature")

  monthly_prec$month <- as.numeric(gsub("wc2.1_10m_prec_", "", monthly_prec$name))
  monthly_temp$month <- as.numeric(gsub("wc2.1_10m_tavg_", "", monthly_temp$name))

  monthly_joined_prec <- monthly_prec %>% mutate(place = coords_data$place[monthly_prec$ID])
  monthly_joined_temp <- monthly_temp %>% mutate(place = coords_data$place[monthly_temp$ID])

  return(list(monthly_prec = monthly_joined_prec, monthly_temp = monthly_joined_temp, annual = coords_data))
}

# Function to plot MAT/MAP
plot_climatology <- function(monthly_data, title, y_label, value_column) {
  ggplot(monthly_data, aes(month, !!sym(value_column), color = factor(place))) +
    geom_line() +
    labs(title = title, y = y_label, color = "Place") +
    theme_bw() +
    theme(plot.title = element_text(size = 14))
}

# Process monet_rs_coords, subset 12 sites and plot
monet_data <- process_climate_data(monet_rs_coords, "Site_Code")
set.seed(42)
sampled_places_monet <- monet_data$annual %>% distinct(place) %>% sample_n(12)
sampled_prec_monet <- monet_data$monthly_prec %>% filter(place %in% sampled_places_monet$place)
sampled_temp_monet <- monet_data$monthly_temp %>% filter(place %in% sampled_places_monet$place)

p_monet_prec <- plot_climatology(sampled_prec_monet, "MAP for MONest subset", "Precipitation", "precipitation")
p_monet_temp <- plot_climatology(sampled_temp_monet, "MAT for MONest subsets", "Air temperature", "temperature")
ggarrange(p_monet_prec, p_monet_temp, ncol = 1, common.legend = TRUE, legend = "bottom")

# Process SRDB_coords, subset 18 and plot
srdb_data <- process_climate_data(SRDB_coords, "Record_number")
set.seed(42)
sampled_places_srdb <- srdb_data$annual %>% distinct(place) %>% sample_n(12)
sampled_prec_srdb <- srdb_data$monthly_prec %>% filter(place %in% sampled_places_srdb$place)
sampled_temp_srdb <- srdb_data$monthly_temp %>% filter(place %in% sampled_places_srdb$place)

p_srdb_prec <- plot_climatology(sampled_prec_srdb, "MAP for SRDB subset", "Precipitation", "precipitation")
p_srdb_temp <- plot_climatology(sampled_temp_srdb, "MAT for SRDB subset", "Air temperature", "temperature")
ggarrange(p_srdb_prec, p_srdb_temp, ncol = 1, common.legend = TRUE, legend = "bottom")

```

#### **SRDB Conversion**

SRDB soil respiration is converted from annual soil respiration to mg CO2-C / g soil / day using the following assumptions and parameters:

-   **Bulk density (**$\rho$): 1.33 g/cm³ (mass of soil per unit volume)
-   **Effective soil depth (**$d$): 10 cm as a common depth for soil respiration measurements
-   **Area conversion**: 1 m² = 10,000 cm²

Using the equation:

$$\text{mg C g⁻¹ soil day⁻¹} = \left( \frac{\text{g C m² yr⁻¹}}{1.33 \times 10 \times 10,000} \right) \times \frac{1}{365} \times 1,000$$

#### **MONet Rs Index**

To represent a single soil respiration data point for each MONet sample core, an index was developed which takes the top and bottom core sample into account as well as the two time points. Given that the majority of biological activity takes place in the top layers of soil, the top sample is weighted greater (65%) than the bottom (35%). After combining top and bottom data for each core, the one and four day respiration rates are given 1/3 and 2/3 weight respectively.

$$\text{Respiration Index} = 0.5 \times \left[ 0.65 \times (\text{24 hr Top} + \text{96 hr Top}) + 0.35 \times (\text{24 hr Bottom} + \text{96 hr Bottom}) \right]$$

```{r tidy MONet Rs data, include = FALSE}

# Select soil respiration from MONet data
monet_rs %>%
  dplyr::select(Sample_Name, respiration_ppm_co2_c,
         respiration_mg_co2_c_g_soil_day_24hour,
         respiration_mg_co2_c_g_soil_day_96hour) -> monet_slim

# Function to separate and add metadata from Sample_Name
extract_metadata <- function(monet_slim) {
  monet_slim %>%
    mutate(
      Site_Code = sapply(strsplit(Sample_Name, "_"), `[`, 3),
      Core_Section = sapply(strsplit(Sample_Name, "_"), `[`, 4)
    )
}

# Extract metadata
monet_rs_metadata <- extract_metadata(monet_slim)

# Integrate this with the annual climate data (MAT, MAP) using Site_Code as key
combined_monet <- monet_rs_metadata %>%
  inner_join(monet_data$annual, by = c("Site_Code" = "place"))

#calculate respiration index and prep for combining with SRDB
monet_rs_index <- combined_monet %>%
  dplyr::select(ID,
                respiration_mg_co2_c_g_soil_day_24hour,
                respiration_mg_co2_c_g_soil_day_96hour,
                Site_Code, Core_Section, MAT, MAP) %>%
  na.omit() %>%
  group_by(ID) %>%
  mutate(weighted_time_respiration = (1/3) * respiration_mg_co2_c_g_soil_day_24hour + (2/3) * respiration_mg_co2_c_g_soil_day_96hour) %>%
  group_by(Site_Code) %>%
  summarise(
    rs_index = sum( case_when(
        Core_Section == "TOP" ~ 0.65 * weighted_time_respiration,
        Core_Section == "BTM" ~ 0.35 * weighted_time_respiration),
      na.rm = TRUE),
    .groups = "drop") %>%
  left_join(combined_monet %>% distinct(Site_Code, MAT, MAP), by = "Site_Code") %>%
  mutate(
    source = "MONet"
  )

```


## One to One for Rs

Using the gridded version of SRDB, we can directly compare 

```{r extract SRDB Rs data, echo = FALSE}


#Plot both Rs datasets
soil_Rh_buffer %>%
  left_join(monet_rs_index, by =  "Site_Code") %>%
  mutate(ymin = srdb_mean - srdb_sd,
         ymax = srdb_mean + srdb_sd)%>%
  ggplot(aes(x = rs_index, y = srdb_mean))+
  geom_point() + lims(x = c(10,80), y = c(10,80)) +
  geom_errorbar(aes(x = rs_index , ymin = ymin, ymax = ymax))+
  geom_abline(intercept = 0, slope = 1, color = "black")+
  stat_smooth(formula = y~x,method = "lm", se = TRUE, level = 0.95)+
  labs(title = "**raw** SRDB Rs vs MONet Rs index",
       x = "mg CO2-C per g soil per d", y = "g CO2-C per m2 per yr")+
  theme_bw()

monet_rs_index$respiration_rate <- monet_rs_index$rs_index

soil_Rh_buffer %>%
  left_join(monet_rs_index, by =  "Site_Code") %>%
  filter(!is.na(rs_index)) %>%
  distinct(Site_Code, respiration_rate, srdb_count, srdb_sd, srdb_mean, MAP, MAT, source)%>%
  dplyr::select(-"respiration_rate") %>%
  mutate(respiration_rate = srdb_mean * 2.06e-05) %>%
  dplyr::select("Site_Code", "respiration_rate",
         "srdb_count", "srdb_sd", "MAT", "MAP") %>%
  mutate(source = "SRDB") -> srdb_ready2_join

bind_rows(monet_rs_index, srdb_ready2_join) -> rs_combined

# Create summary table
summary_table <- rs_combined %>%
  group_by(source) %>%
  summarize(
    min_respiration_rate = min(respiration_rate, na.rm = TRUE),
    max_respiration_rate = max(respiration_rate, na.rm = TRUE),
    mean_respiration_rate = mean(respiration_rate, na.rm = TRUE)
  )%>%
  mutate(Units = "g CO2-C per m2 per yr")

# Display the table using kable
summary_table %>%
  kable(
    caption = "Summary of Respiration Rate by Source",
    col.names = c("Source", "Min Respiration Rate", "Max Respiration Rate", "Mean Respiration Rate", "Units"),
    format = "html"
  )

```

## Impact of MAP and MAT on Soil Respiration by source

```{r Rs Analysis, fig.dim=c(6,4), fig.align='center'}

cd4m <- rs_combined %>%
  group_by(source) %>%
  mutate(respiration_z = (respiration_rate - mean(respiration_rate)) / sd(respiration_rate)) %>%
  ungroup()

### Step 1: Linear Model of Z-Scaled Data
model1 <- lm(respiration_z ~ source + MAT + MAP, data = cd4m)
summary(model1)

### Step 2: Reshape Data and Facetted Plot
cd4m %>%
  pivot_longer(cols = c(MAT, MAP), names_to = "climate_parameter", values_to = "climate_value") %>%
  ggplot(aes(x = climate_value, y = respiration_z)) +
  geom_point(aes(color = source), alpha = 0.7, size = 3) + # Scatter plot
  geom_smooth(method = "lm", se = FALSE, aes(color = source)) + # Regression line
  facet_wrap(climate_parameter ~ ., scales = "free_x") + # Facet by source and climate_parameter
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"),
        group = source,
        color = source),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) + # Regression equation and R²
  labs(
    title = "Rs vs Climate by Data Source",
    x = "Climate Parameter",
    y = "Z-score Respiration Rate (mg C per g soil per day)"
  ) +
  scale_color_manual(values = c("SRDB" = "#0072B2", "MONet" = "#D55E00")) +
  theme_bw()

### Step 3: Original, non-Z-scaled data
model2 <- lm(respiration_rate ~ source + MAT + MAP, data = cd4m)
summary(model2)

cd4m %>%
  pivot_longer(cols = c(MAT, MAP), names_to = "climate_parameter", values_to = "climate_value") %>%
  ggplot(aes(x = climate_value, y = respiration_rate)) +
  geom_point(aes(color = source), alpha = 0.7, size = 3) + # Scatter plot
  geom_smooth(method = "lm", se = FALSE, aes(color = source)) + # Regression line
  facet_wrap(source ~ climate_parameter, scales = "free") + # Facet by source and climate_parameter
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"),
        group = source,
        color = source),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) + # Regression equation and R²
  labs(
    title = "Rs vs Climate by Data Source",
    x = "Climate Parameter",
    y = "NOTE VARIABLE SCALE \n Respiration Rate (mg C per g soil per day)"
  ) +
  scale_color_manual(values = c("SRDB" = "#0072B2", "MONet" = "#D55E00")) +
  theme_bw()

```



# 2. pH assessemnt within Köppen Climate Zones and directly to SoilGrids

Soil pH, acts as a proxy for biochemical interactions, particularly with abiotic factors such as soil mineralogy and atmospheric chemical deposition. As a fundamental property of soil chemistry, it provides valuable context for interpreting molecular observations. In this section, MONet soil pH measurements are compared to pH estimates from SoilGrids at regional scale by Köppen Climate Zone and by the location of each sample.

## Extract Köppen Climate Zones for MONet data

![CONUS Köppen Climate Zones of North America](./figures/conus_climate_zones_MONet.png)


## MONet vs SoilGrids density distributions

SoilGrids values are extracted at MONet sampling coordinates to enable direct point-to-point comparisons of pH. The distribution of these points are compared to evaluated ability of direct geographic comparisons.

![Density distribution of pH data.](./figures/pH_hist.png)

In general, MONet data does moderately well at capturing the distribution of pH seen in SoilGrids.\

![One to One SoilGrids vs MONet pH.](./figures/pH_OneToOne_plot.png)
When comparing the data sources by MONet sample location, we found that compared to SoilGrids, MONet samples tend to underestimate values at the lower end of the pH range and over estimate at the higher end.

The following MONet sites were excluded from the following analysis since there was only one sample available for the climate zone:

-   Anza Borrego Desert State (Hot Desert Climate)\
-   Santa Rita Experimental Range NEON (Hot Semi-Arid Climate)\
-   Northern Great Plains Research Laboratory NEON (Humid Continental Hot Summers with Dry Winters)\
-   Dakota Coteau Field Site NEON (Humid Continental Mild Summer with Dry Winters)\
-   Peterson Farm (Temperate Oceanic Climate)\
-   Beaver Creek, Washington (Warm-Summer Mediterranean Climate)

For each region with more than one MONet site, 1,000 observations of Soilgrids data were randomly sampled to illustrate the distribution of pH and clay content in each climate zone.

## Plot distribution of pH in each region

```{r SG functions, include = FALSE}

sg_random_sample <- function(MONet_sg_top, sample_sizes_sg_top, seeds){
  
  MONet_data <- MONet_sg_top %>%
    filter(source == "MONet")
  
  for(seed in seeds){
    set.seed(seed)
    for(zone in unique(sample_sizes_sg_top$Climate)){
      
      n_samples <- sample_sizes_sg_top$MONet[sample_sizes_sg_top$Climate == zone]
    
      sampled_sg_zone <- MONet_sg_top%>%
        as.data.frame()%>%
        filter(Climate == zone, source != "MONet")%>%
        slice_sample(n = n_samples)%>%
        mutate(source = paste0("soilgrids_sample_", which(seed == seeds)))
      
      MONet_data <- bind_rows(MONet_data, sampled_sg_zone)
    }
  }
    return(MONet_data)
}

process_soil_data <- function(type, section, MONet_df, sg_df, climate_mapping_df, sg_column_name) {
  # Process MONet data
  MONet_data <- MONet_df %>%
    left_join(climate_mapping_df, by = c("Climate", "Code")) %>%
    filter(core_section == section) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "MONet")

  # Process SoilGrids data
  sg_data <- sg_df %>%
    left_join(climate_mapping_df, by = c("zone" = "Code")) %>%
    filter(Climate %in% unique(MONet_data$Climate)) %>%
    rename(!!type := sg_column_name) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "soilGrids",
           !!type := !!sym(type) / 10) # convert units

  # Combine MONet and SoilGrids data
  combined_data <- bind_rows(MONet_data, sg_data)
  return(combined_data)
}

```

We compared the distribution of MONet pH measurements by climate zone to a random sample of the same number of points from each climate zone in SoilGrids. The median pH in the MONet samples was generally within the spread of the of the 25th and 75th confidence intervals of the SoilGrids samples.

![Random sampling of SoilGrids vs MONet pH.](./figures/pH_random_sample.png)


# 3. Spatial Comparison of Clay Content

## MONet datapoints not in soilgrids

This analysis identified 6 MONet sample sites in locations with incomplete data in the soil grids dataset. Even though these locations are considered as urban sites and not recorded in soil grids, having data on the soil biogeochemistry composition can offer insights into soil health and processes in urban environments. The 6 locations were made up of 3 site in College Park, MD, 2 in Baltimore, MD, and 1 in Philadelphia, PA:

-   Northwest Baltimore Base of Slope Adelphi, MD
-   Northwest Baltimore Mid Slope Adelphi, MD
-   Northwest Baltimore Top of Slope Adelphi, MD
-   Winters Lane Lower Soil Pit (Baltimore, MD)
-   Winters Lane Upper Soil Pit (Baltimore, MD)
-   Urban CZO (Philadelphia, PA)

```{r MONet not in Soilgrids, fig.dim=c(6,5), fig.align='center', cache = TRUE}
# TODO this is what is also slow( lets move to the preprocessing)
monet_clay_missing <- rbind(sg_clay_monet_top_values%>%
                              filter(is.na(crop_roi_igh_clay_0.5cm))%>%
                              dplyr::select(Clay_percent, source, core_section, sample),
                            sg_clay_monet_btm_values%>%
                              filter(is.na(crop_roi_igh_clay_15.30cm))%>%
                              dplyr::select(Clay_percent, source, core_section, sample))%>%
  mutate(missing = TRUE)


missing_clay <- clay_loc_sf_top%>%
  left_join(monet_clay_missing, by = c("core_section", "Clay_percent", "source", "sample"))%>%
  filter(missing == TRUE)%>%
  separate(sample, into = c("prj", "Site_Code"))%>%
  left_join(data.frame(monet_rs_coords), by = c("Site_Code"))%>%
  mutate(location = substr(Site_Code, 1,2))%>%
  group_by(location)%>%
  mutate(samples = paste0("n = ", n()))%>%
  ungroup()

sg_clay_conus_top <- terra::rast("R_data/sg_clay_conus_top.tif")
conus_valid <- read_sf("data/shapefiles/conus_valid.shp")

crop_extent <- terra::ext(-78, -74.5, 38.25, 40.5) # Define crop extent
sg_clay_top_prj_final <- terra::crop(sg_clay_conus_top, crop_extent)  # Crop raster to extent
#TODO is this what is slow?
# ggplot()+
#   tidyterra::geom_spatraster(data = sg_clay_top_prj_final)+
#   geom_sf(data = conus_valid, color = "black", alpha = 0.5)+
#   geom_sf(data = missing_clay, color = "black", size = 3.5)+
#   geom_sf(data = missing_clay, aes(color = Site_Code), size = 3)+
#   geom_sf_label(data = missing_clay, aes(label = samples), nudge_y = 0.01, nudge_x = -.3)+
#   coord_sf(xlim = c(-78,-74.5),ylim = c(38.25,40.5))+
#   theme_bw()+
#   scale_fill_gradient(low = 'white', high = 'blue', na.value=NA)+
#   labs(title = "MONet data points without Soilgrids data")


```

## Clay 1:1

## MONet vs SoilGrids density distributions

SoilGrids values are extracted at MONet sampling coordinates to enable direct point-to-point comparisons of clay content. The distribution of these points are compared to evaluated ability of direct geographic comparisons.

![Density distribution of clay data.](./figures/clay_hist.png)

![One to One SoilGrids vs MONet Clay.](./figures/clay_OneToOne_plot.png)
When comparing the data sources by MONet sample location, we found that compared to SoilGrids, MONet samples tend to underestimate values at the lower end of the clay content range and over estimate at the higher end.

## Clay Content Violins



```{r clay violin plots, fig.dim=c(10,10), echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE}

generate_violin_plots <- function(plot_data, value_col, source_mapping, title, x_label){
  plot_data%>%
    mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
    filter(!is.na(axis_label))%>%
    ggplot(aes(x = !!sym(value_col), y = axis_label, fill = Experiment, color = Experiment)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   scale_fill_manual(name = "Experiment", values = myColors, labels = source_mapping)+
   scale_color_manual(name = "Experiment", values = myColors, labels = source_mapping)+
   labs(
     title = title,
     x = x_label,
     y = "Climate Zone"
   )+
  scale_y_discrete(labels = label_wrap_gen(30))
}

generate_violin_plots(plot_data = plot_clay_top,
                      value_col = "Clay_percent", 
                      source_mapping = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"),
                      title = "MONet and Soilgrids Clay Content by Climate Zone (Top sample)", 
                      x_label = "Clay Content (%)")

generate_violin_plots(plot_data = plot_clay_btm,
                      value_col = "Clay_percent", 
                      source_mapping = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"),
                      title = "MONet and Soilgrids Clay Content by Climate Zone (Bottom sample)", 
                      x_label = "Clay Content (%)")

```

## Overlay Map

```{r spatial comparison, fig.dim = c(8,8), fig.align='center', echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, cache.lazy = FALSE}


ggplot()+
  tidyterra::geom_spatraster(data = sg_clay_conus_top) +
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  geom_sf(data = clay_loc_sf_top, aes(fill = Clay_percent), colour = "black", size =3)+
  geom_sf(data = clay_loc_sf_top, aes(color = Clay_percent), size =2)+
  theme_bw()+
  scale_fill_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85))+
  scale_color_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85), guide = "none")+
  labs(
    title = "Spatial Comparison of MONet Clay Content to Soilgrids (Top sample)",
    fill = "% Clay")+
  theme(plot.title = element_text(size = 12),
        plot.margin=margin(0,0,0,0, "mm"))


```

![Spatial Comparison of MONet and GCAM Clay.](./figures/MONet_GCAM_plot.png)

## GCAM Clay Comparisons

```{r future home of GCAM clay figure}
MONet_GCAM_clay%>%
  filter(core_section == "TOP")%>%
  mutate(ymin = gcam_q1_value,
         ymax = gcam_q3_value)%>%
  ggplot(aes(x = Clay_percent_mean , y = gcam_average))+
  geom_point(aes(color = glu_nm))+
  stat_smooth(formula = y~x,method = "lm", se = TRUE, level = 0.95, alpha = 0.5)+
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  )+
  geom_errorbar(aes(x = Clay_percent_mean , ymin = ymin, ymax = ymax, color = glu_nm), alpha = 0.5)+
  geom_errorbar(aes(x = gcam_average , xmin = Clay_percent_mean - monet_sd, xmax = Clay_percent_mean + monet_sd, color = glu_nm), alpha = 0.5)+
  geom_abline(intercept = 0, slope = 1, color = "black")+
  labs(title = "GCAM vs MONet Clay Content by Basin",
       x = "MONet (% Clay)", y = "GCAM (% Clay)")+
  theme_bw()+
  theme(plot.title = element_text(size = 16))

```
