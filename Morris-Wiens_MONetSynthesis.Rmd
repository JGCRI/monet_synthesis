---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,           # Show code in output
  warning = FALSE,       # Hide warning messages
  message = FALSE,       # Hide package loading messages)
  fig.width = 8,         # Default figure width
  fig.height = 10         # Default figure height
)
```

# Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). This script executes a series of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within KÃ¶ppen climatic zones, 3) and the spatial distribution of soil clay content (Table 1). Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013).

## Load Packages

General data manipulation: `dplyr` and `tidyr`

Plotting: `ggplot2`, `ggpubr`

Geographic data handling: `sf`, `terra`, `raster`, `tiff`

Precipitation and Temperature data: `geodata`

```{r libraries, results = "hide"}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(terra)
library(tidyterra)
library(raster)
library(tiff)
library(geodata)
#library(colorBlindness)

```

```{r}
myColors_all <- colorBlindness::Blue2Orange12Steps
myColors <- myColors_all[c(1:3, 9:11)]
myColors <- c( "#000080","#4040A0","#8080C0", "#D6AA80", "#D98040", "#CC5500")
names(myColors) <- c("MONet_resp", "MONet_pH", "MONet_clay", "comp_clay", "comp_pH", "comp_resp")

#"#007FFF"  "#4CC3FF"  "#99EDFF"  "#CCFFFF"  "#FFFFCC"  "#FFEE99"  "#FFC34C"  "#FF7F00"
# "#002AFF" "#1965FF" "#3299FF" "#65CCFF" "#99EDFF" "#CCFFFF" "#FFFFCC" "#FFEE99" "#FFCC65" "#FF9932" "#FF6619" "#FF2A00"
# 
# "#CC5500" "#D98040" "#D6AA80" 
# "#000080" "#4040A0" "#8080C0"

```

# 1. Comparison of Soil Respiration relative to MAP and MAT

## Read in MONet respiration and SRDB data

Read in the experiment data and associated sample location files for the MONet and the SRDB soil respiration data and filter for observations located in the Continental United States (CONUS). The target coordinate reference system (CRS) is defined as WGS84 in this chunk and used to ensure spatial consistency through the rest of the markdown. The coordinates of MONet and SRDB locations are plotted for reference.

If your data directory is missing any of the files below, download them from their respective sources into the "data" folder.

[MONet soil respiration](https://zenodo.org/records/15328215)

[SRDB](https://github.com/bpbond/srdb)

[United States shapefile](https://www.weather.gov/gis/USStates)

```{r Comparison of Soil Respiration relative to MAP and MAT, results = "hide", warning = FALSE, message = FALSE}

# read in site coordinates and data
monet_rs <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
rs_coord <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")
srdb <- read.csv("data/srdb/srdb-20250503a/srdb-data.csv")

# state codes for filtering CONUS
state_abbreviations_conus <- c(
  "AL", "AZ", "AR", "CA", "CO",
  "CT", "DE", "FL", "GA", "ID",
  "IL", "IN", "IA", "KS", "KY",
  "LA", "ME", "MD", "MA", "MI",
  "MN", "MS", "MO", "MT", "NE",
  "NV", "NH", "NJ", "NM", "NY",
  "NC", "ND", "OH", "OK", "OR",
  "PA", "RI", "SC", "SD", "TN",
  "TX", "UT", "VT", "VA", "WA",
  "WV", "WI", "WY"
)

# Read and ensure valid shapes for CONUS
conus_valid <- st_read("data/shapefiles/s_18mr25/s_18mr25.shp") %>%
  st_make_valid() %>%
  filter(STATE %in% state_abbreviations_conus) %>%
  st_transform("WGS84")

# Define the target CRS from the shapefile
target_crs <- st_crs(conus_valid)

# Disable S2 processing to use GEOS for spatial operations
sf_use_s2(FALSE)

# Filter SRDB coordinates within shapefile boundaries
SRDB_coords <- srdb %>%
  dplyr::select(Record_number, Latitude, Longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
  st_transform(target_crs) %>%
  {.[rowSums(st_within(., conus_valid, sparse = FALSE)) > 0, ]}

# Convert rs_coord to sf assuming the column names are 'Long' and 'Lat'
monet_rs_coords <- rs_coord %>%
  filter(Site_Code != "PUUM") %>% #Take out one
  st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  st_transform(target_crs)

# Plotting both sets of coordinates
ggplot() +
  geom_sf(data = conus_valid, fill = NA, color = "gray", linetype = "solid") +
  geom_sf(data = SRDB_coords, aes(color = 'SRDB Source'), size = 2, alpha = 0.7) +
  geom_sf(data = monet_rs_coords, aes(color = 'Monet RS Source'), size = 2, alpha = 0.7) +
  scale_color_manual(values = c('SRDB Source' = myColors[[6]], 'Monet RS Source' = myColors[[1]])) +
  theme_bw() +
  labs(title = "Map of Coordinates from MONet and SRDB",
       color = "Data Source") +
  theme(legend.position = "bottom")
```

## Extract Mean Annual Precipitation (MAP) and Mean Annual Temperature (MAT) for sample coordinates

Using the `geodata` package, \~1km\^2 gridded 10 minute precipitation and average temperature data from 1970-2000 is downloaded and and extracted at the MONet and SRDB sample sites. These data are then used to create timeseries of MAP and MAP for each sample location. A selection of sites are plotted for illustration.

```{r Extract MAP and MAT for samples, results = "hide"}
# Function to extract climate data: precipitation and temperature
process_climate_data <- function(coords_df, ID_column) {
  coords_extracted <- st_coordinates(coords_df)
  coords_data <- tibble(place = coords_df[[ID_column]], lon = coords_extracted[, "X"], lat = coords_extracted[, "Y"])
  coords_data$ID <- seq_len(nrow(coords_data))

  # WorldClim data extraction
  tavg <- worldclim_global("tavg", "10", "data/worldclim_data/")
  tprec <- worldclim_global("prec", "10", "data/worldclim_data/")

  tavg_extracted <- terra::extract(tavg, coords_data[, c("lon", "lat")])
  tprec_extracted <- terra::extract(tprec, coords_data[, c("lon", "lat")])

  # Calculate MAT and MAP
  coords_data <- coords_data %>%
    mutate(MAT = rowMeans(tavg_extracted[, -1], na.rm = TRUE),
           MAP = rowMeans(tprec_extracted[, -1], na.rm = TRUE) * 12) # Convert to annual precipitation

  # Reshape monthly precipitation data
  monthly_prec <- pivot_longer(tprec_extracted, -ID, names_to = "name", values_to = "precipitation")
  
  # Reshape monthly temperature data
  monthly_temp <- pivot_longer(tavg_extracted, -ID, names_to = "name", values_to = "temperature")

  monthly_prec$month <- as.numeric(gsub("wc2.1_10m_prec_", "", monthly_prec$name))
  monthly_temp$month <- as.numeric(gsub("wc2.1_10m_tavg_", "", monthly_temp$name))

  monthly_joined_prec <- monthly_prec %>% mutate(place = coords_data$place[monthly_prec$ID])
  monthly_joined_temp <- monthly_temp %>% mutate(place = coords_data$place[monthly_temp$ID])

  return(list(monthly_prec = monthly_joined_prec, monthly_temp = monthly_joined_temp, annual = coords_data))
}

# Plot function for climatology
plot_climatology <- function(monthly_data, title, y_label, value_column) {
  ggplot(monthly_data, aes(month, !!sym(value_column), color = factor(place))) +
    geom_line() +
    ylab(y_label) +
    ggtitle(title) +
    theme_bw() +
    theme(legend.position = "bottom")
}

# Process monet_rs_coords, subset 18 and plot
monet_data <- process_climate_data(monet_rs_coords, "Site_Code")
set.seed(42)
sampled_places_monet <- monet_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_monet <- monet_data$monthly_prec %>% filter(place %in% sampled_places_monet$place)
sampled_temp_monet <- monet_data$monthly_temp %>% filter(place %in% sampled_places_monet$place)

p_monet_prec <- plot_climatology(sampled_prec_monet, "Precipitation for Sampled Monet RS Coords", "Precipitation", "precipitation")
p_monet_temp <- plot_climatology(sampled_temp_monet, "Temperature for Sampled Monet RS Coords", "Air temperature", "temperature")
print(p_monet_prec)
print(p_monet_temp)

# Process SRDB_coords, subset 18 and plot
srdb_data <- process_climate_data(SRDB_coords, "Record_number")
set.seed(42)
sampled_places_srdb <- srdb_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_srdb <- srdb_data$monthly_prec %>% filter(place %in% sampled_places_srdb$place)
sampled_temp_srdb <- srdb_data$monthly_temp %>% filter(place %in% sampled_places_srdb$place)

p_srdb_prec <- plot_climatology(sampled_prec_srdb, "Precipitation for Sampled SRDB Coords", "Precipitation", "precipitation")
p_srdb_temp <- plot_climatology(sampled_temp_srdb, "Temperature for Sampled SRDB Coords", "Air temperature", "temperature")
print(p_srdb_prec)
print(p_srdb_temp)

# Final annual dataframe
print("Annual data for Monet RS Coords")
head(monet_data$annual)
print("Annual data for SRDB Coords")
head(srdb_data$annual)
```

## Identify relationship between soil respiration in SRDB to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on annual soil respiration.

```{r SRDB MAP and MAT relationship}

# Select annual respiration from SRDB dadta
srdb %>%
  dplyr::select(Rs_annual, Record_number) -> srdb_slim

# Rename the 'place' column in srdb_data$annual to match 'Record_number' in srdb_slim
srdb_annual <- srdb_data$annual %>%
  rename(Record_number = place)

# Combine datasets by 'Record_number'
combined_data <- srdb_slim %>%
  inner_join(srdb_annual, by = "Record_number")

# Inspect the combined data
head(combined_data)

# Linear regression model to test the effect of MAP and MAT on Rs_annual
model <- lm(Rs_annual ~ MAP + MAT, data = combined_data)
summary(model)

# Print regression summary
print(summary(model))

# Plot Rs_annual vs MAP
plot_MAP <- ggplot(combined_data, aes(x = MAP, y = Rs_annual)) +
  geom_point(color = myColors["comp_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Effect of MAP on Rs_annual",
       x = "Mean Annual Precipitation (MAP)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))

# Plot Rs_annual vs MAT
plot_MAT <- ggplot(combined_data, aes(x = MAT, y = Rs_annual)) +
  geom_point(color = myColors["comp_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "red") +
  labs(title = "Effect of MAT on Rs_annual",
       x = "Mean Annual Temperature (MAT)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))

```

## Identify relationship between soil respiration in MONet to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on annual soil respiration.

```{r MONet MAP and MAT respiration relationship}

# Select soil respiration from MONet data
monet_rs %>%
  dplyr::select(Sample_Name, respiration_ppm_co2_c,
         respiration_mg_co2_c_g_soil_day_24hour,
         respiration_mg_co2_c_g_soil_day_96hour) -> monet_slim

# Function to separate and add metadata from Sample_Name
extract_metadata <- function(monet_slim) {
  monet_slim %>%
    mutate(
      Site_Code = sapply(strsplit(Sample_Name, "_"), `[`, 3),
      Core_Section = sapply(strsplit(Sample_Name, "_"), `[`, 4)
    )
}

# Extract metadata
monet_rs_metadata <- extract_metadata(monet_slim)

# Integrate this with the annual climate data (MAT, MAP) using Site_Code as key
combined_monet <- monet_rs_metadata %>%
  inner_join(monet_data$annual, by = c("Site_Code" = "place"))

# Compute linear models and summarize using select() inside group_by
lm_models <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_ppm_co2_c ~ MAT, data = dplyr::select(., MAT, respiration_ppm_co2_c))),
    model_MAP = list(lm(respiration_ppm_co2_c ~ MAP, data = dplyr::select(., MAP, respiration_ppm_co2_c)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models)) {
  cat("Core Section: ", lm_models$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting Rs_annual vs MAT and MAP for each Core_Section separately
# Change 'Rs_annual' column as necessary to match the respiration data you are plotting

p_monet_MAT_core <- ggplot(combined_monet, aes(x = MAT, y = respiration_ppm_co2_c, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.title.y = element_text(size = 7))

p_monet_MAP_core <- ggplot(combined_monet, aes(x = MAP, y = respiration_ppm_co2_c, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.title.y = element_text(size = 7))

p_monet_SRDB_MAT <- ggarrange(p_monet_MAT_core, plot_MAT,
          labels = c("MONet", "SRDB"),
          nrow = 2, ncol = 1, 
          heights = c(10,10),
          vjust = -.2)+
  theme(plot.margin = margin(.6,0,0,0, "cm"))

p_monet_SRDB_MAP <- ggarrange(p_monet_MAP_core, plot_MAP,
          labels = c("MONet", "SRDB"),
          nrow = 2, ncol = 1, 
          heights = c(10,10),
          vjust = -.2)+
  theme(plot.margin = margin(.6,0,0,0, "cm")) 


```

## Compare the influences of MAT and MAP on soil respiration in MONet vs SRDB

```{r MAT and MAP plots}

print(p_monet_SRDB_MAT)

print(p_monet_SRDB_MAP)

```

## Identify relationship between mg C-CO2 per 24 soil respiration in MONet to MAP and MAT

```{r MONet 24h respiration}

# Compute linear models and summarize using select() inside group_by
lm_models_24h <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_mg_co2_c_g_soil_day_24hour ~ MAT, data = dplyr::select(., MAT, respiration_mg_co2_c_g_soil_day_24hour))),
    model_MAP = list(lm(respiration_mg_co2_c_g_soil_day_24hour ~ MAP, data = dplyr::select(., MAP, respiration_mg_co2_c_g_soil_day_24hour)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models_24h)) {
  cat("Core Section: ", lm_models_24h$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models_24h$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models_24h$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting 24h respiration vs MAT and MAP for each Core_Section separately

p_monet_MAT_core_24h <- ggplot(combined_monet, aes(x = MAT, y = respiration_mg_co2_c_g_soil_day_24hour, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on 24h Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")+
  xlim(8,16)

p_monet_MAP_core_24h <- ggplot(combined_monet, aes(x = MAP, y = respiration_mg_co2_c_g_soil_day_24hour, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on 24h Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

print(p_monet_MAT_core_24h)
print(p_monet_MAP_core_24h)
```

## Identify relationship between mg C-CO2 per 96h soil respiration in MONet to MAP and MAT

```{r MONet 96h respiration}

# Compute linear models and summarize using select() inside group_by
lm_models_96h <- combined_monet %>%
  group_by(Core_Section) %>%
  summarise(
    model_MAT = list(lm(respiration_mg_co2_c_g_soil_day_96hour ~ MAT, data = dplyr::select(., MAT, respiration_mg_co2_c_g_soil_day_96hour))),
    model_MAP = list(lm(respiration_mg_co2_c_g_soil_day_96hour ~ MAP, data = dplyr::select(., MAP, respiration_mg_co2_c_g_soil_day_96hour)))
  )

# Display model summaries for 'MAT' and 'MAP'
for (i in 1:nrow(lm_models_96h)) {
  cat("Core Section: ", lm_models_96h$Core_Section[i], "\n")
  cat("Model MAT Summary:\n")
  print(summary(lm_models_96h$model_MAT[[i]]))
  cat("\nModel MAP Summary:\n")
  print(summary(lm_models_96h$model_MAP[[i]]))
  cat("\n----------------------\n")
}

# Plotting 96h respiration vs MAT and MAP for each Core_Section separately

p_monet_MAT_core_96h <- ggplot(combined_monet, aes(x = MAT, y = respiration_mg_co2_c_g_soil_day_96hour, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAT on 96h Respiration by Core Section for Monet Data",
       x = "Mean Annual Temperature (MAT)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")+
  xlim(8,16)

p_monet_MAP_core_96h <- ggplot(combined_monet, aes(x = MAP, y = respiration_mg_co2_c_g_soil_day_96hour, color = Core_Section)) +
  geom_point(color = myColors["MONet_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "black") +
  facet_wrap(~Core_Section) +
  labs(title = "Effect of MAP on 96h Respiration by Core Section for Monet Data",
       x = "Mean Annual Precipitation (MAP)",
       y = "Respiration (CO2 ppm in core sub-section)") +
  theme_bw() +
  theme(legend.position = "bottom")

print(p_monet_MAT_core_96h)
print(p_monet_MAP_core_96h)
```

# pH and Clay Comparison between MONet and Soilgrids

## Reading pH and clay content data from MONet and 1000 soils database

Read in the experiment data and sample location files for the pH and clay data from MONet and the 1000 soil database. If your data directory is missing any of the files below, download them from their respective sources put into the "data" folder.

[MONet](https://sc-data.emsl.pnnl.gov/monet)

[1000 soils](https://zenodo.org/records/15328215)

```{r read in MONet data}

# read in site coordinates
monet_pH_coord <- read.csv("data/MONet/pH/processed_data/Coordinates.csv")
monet_clay_coord <- read.csv("data/MONet/clay/processed_data/Coordinates.csv")

# read in site data
monet_pH_data <- read.csv("data/MONet/pH/processed_data/Soil_BioChemical_properties.csv")
monet_clay_data <- read.csv("data/MONet/clay/processed_data/Soil_BioChemical_properties.csv")

# read in 1000soil sample data
processed_1000s <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
metadata_1000s <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")

```

## Join pH and clay site locations to data and combine MONet and 1000 soils

Join the MONet soil sample data to the sample coordinates using the proposal ID and sample number of the associated data. The data from the 1000 soils experiment is joined to the corresponding coordinates using a similar method.

MONet and 1000 soils data are then formatted and joined to create the a table of all measured pH and Clay data.

```{r Join data}

# Join MONet pH sample data and location
monet_pH_loc <- monet_pH_data%>%
  # Separate the Sample_Name column into distict columns
  separate(Sample_Name, into = c("proposal_id", "sample", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sample = as.numeric(sample))%>%
  # Join to the coordinated by proposal ID and sample set
  left_join(monet_pH_coord, by = c("proposal_id", "sample" = "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sample = as.character(sample))%>%
  dplyr::select(proposal_id, sample, core_section, pH, latitude, longitude)%>%
  mutate(source = "MONet")

# Join MONet clay content sample data and location
monet_clay_loc <- monet_clay_data%>%
  # Separate the Sample_Name column into distict columns
  separate(Sample_Name, into = c("proposal_id", "sample", "core_section"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sample = as.numeric(sample))%>%
  left_join(monet_clay_coord, by = c("proposal_id", "sample" = "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude),
         sample = as.character(sample))%>%
  dplyr::select(proposal_id, sample, core_section, Clay_percent, latitude, longitude)%>%
  mutate(source = "MONet")

# Join 1000 soil sample data and location
processed_1000s_loc <- processed_1000s%>%
  separate(Sampling_Set, into = c("prj", "Site_Code"))%>%
  left_join(metadata_1000s, by = c("Site_Code"))%>%
  filter(!is.na(Lat))%>%
  # format to MONet structure
  dplyr::select(proposal_id = Proposal_ID, sample = prj, 
                core_section = Core_Section, pH, Clay_percent, 
                latitude = Lat, longitude = Long)%>%
  mutate(source = "1000s")

# Bind MONet data with 1000s clay and pH data
monet_pH <- bind_rows(monet_pH_loc, dplyr::select(processed_1000s_loc, -Clay_percent))

monet_clay <- bind_rows(monet_clay_loc, dplyr::select(processed_1000s_loc, -pH))

```

## Extract Koppen Climate Zones for MONet data

This section loads a shapefile of the Koppen Climate Zones of North America, filters the climate zone shapefile to CONUS, and extracts the climate region for each data site location in the MONet and 1000 soils experiments. All spatial data are transformed into the target CRS to ensure accuracy.

If your data directory is missing the file below, download and move into the "data" folder.

[North American Koppen Climate Zones](https://www.cec.org/north-american-environmental-atlas/climate-zones-of-north-america)

## Load in North American Climate Zones

```{r load climate, warning=FALSE, message=FALSE}
# Load the shapefile as an `sf` object
climate_zones_sf <- st_read("data/shapefiles/na_climatezones_shapefile/climatezones_shapefile/NA_ClimateZones/data/North_America_Climate_Zones.shp")%>%
  st_transform(crs(conus_valid))

# Create a mapping table for the 3 letter climate zone code to the full name
climate_zone_mapping <- climate_zones_sf%>%
  distinct(Code, Climate)

# Find intersection of climate zones and CONUS
climate_zones_conus_sf <- climate_zones_sf%>%
  st_intersection(st_union(conus_valid))

ggplot() +
  geom_sf(data = climate_zones_conus_sf, aes(fill = Climate), color = "darkslategrey", alpha = 1) +
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  geom_sf(data = monet_rs_coords, size = 2) +
  theme_bw()+
  #geom_sf(data = pH_loc_sf)+
  labs(title = "CONUS Koppen Climate Zones of North America") +
  theme(legend.position = "none")


```

## Convert MONet data points to `sf` objects and extract Koppen climate zone information

Convert MONet pH and clay content data tables to sf objects using the `sf` package. The coordinates for MONet sample sites were collected using the basic WGS84 projection which is the default CRS for this analysis. The MONet data is then divided by the sample height. Each MONet sample core is 30cm and analysis is carried out on the top and bottom of the core, the top sample is the soil from 0cm (the surface) to 10cm under the surface and the bottom sample is from 20cm to 30cm under the surface. These depths exhibit different characteristics in the qualities in this analysis and therefore are handled separately.

Once the pH and clay data from MONet and 1000 soils are converted into shapefile point data types, use `st_join` from the `sf` library to get the climate zone for each sample site.

```{r convert to sf }

# Convert MONet pH data into shapefile object setting CRS to the target WGS1984, clip points wihtin CONUS
pH_loc_sf <- st_as_sf(monet_pH, coords = c("longitude", "latitude"), crs = target_crs)%>%
  st_intersection(st_union(conus_valid))%>%
  filter(!is.na(pH))

# Filter for top and bottom samples
pH_loc_sf_top <- pH_loc_sf%>%filter(core_section == "TOP")
pH_loc_sf_btm <- pH_loc_sf%>%filter(core_section == "BTM")

# Convert MONet clay content data into shapefile object setting CRS to the target WGS1984, clip points within CONUS
clay_loc_sf <- st_as_sf(monet_clay, coords = c("longitude", "latitude"), crs = target_crs)%>%
  st_intersection(st_union(conus_valid))%>%
  filter(!is.na(Clay_percent))

# Filter for top and bottome samples
clay_loc_sf_top <- clay_loc_sf%>%filter(core_section == "TOP")
clay_loc_sf_btm <- clay_loc_sf%>%filter(core_section == "BTM")

# Join point data to Koppen shapefile to extract climate zone information for each point
pH_zones <- st_join(pH_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sample, core_section, pH, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

clay_zones <- st_join(clay_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sample, core_section, Clay_percent, source, Code, Climate, Key_EN, geometry)%>%
  filter(!is.na(Climate))

```

# 2. Assessemnt of pH within Koppen Climate Zones

## Plot distribution of characteristics in each region

```{r plot pH and clay}
pH_zones%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_pH", "comp_pH")))%>%
  ggplot()+
  geom_boxplot(aes(x = pH, y = Climate, fill = Experiment))+
  labs(title = "MONet and 1000 soils pH Distributiton\n by Climate Zone")+
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "1000s", "MONet_pH" = "MONet"))
  
clay_zones%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
  ggplot()+
  geom_boxplot(aes(x = Clay_percent, y = Climate, fill = Experiment))+
  labs(title = "MONet and 1000 Soils Clay Content\n by Climate Zone")+
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "1000s", "MONet_clay" = "MONet"))
  
```

## Sites and samples by state

```{r samples by state, echo=FALSE, warning=FALSE, message=FALSE}
# pH_zones%>%
#   st_join(CONUS_sf)%>%
#   group_by(NAME)%>%
#   dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sample))%>%
#   arrange(desc(n_proposals), desc(n_samples))
# 
# clay_zones%>%
#   st_join(CONUS_sf)%>%
#   group_by(NAME)%>%
#   dplyr::summarize(n_proposals = n_distinct(proposal_id), n_samples = n_distinct(sample))%>%
#   arrange(desc(n_proposals), desc(n_samples))
# 

```

# Read in soilGrids clay content data and clip to CONUS

```{r soilGrids data, echo=FALSE, warning=FALSE, message=FALSE}


# if soilgrid data has already been processed and saved to .RData, load in RData
if(!"sg_data.RData" %in% list.files()){
  
  # Clay content soil grids rastes
  sg_clay_0_5cm <- rast("./data/soilgrids/crop_roi_igh_clay_0-5cm.tif")
  sg_clay_15_30cm <- rast("./data/soilgrids/crop_roi_igh_clay_15-30cm.tif")
  
  # pH soil grid rasters
  sg_pH_0_5cm <- rast("./data/soilgrids/crop_roi_igh_ph_0-5cm.tif")
  sg_pH_15_30cm <- rast("./data/soilgrids/crop_roi_igh_ph_15-30cm.tif")
  

  # This step takes a long time
  # Projects soild grids clay and pH rasters to WGS 1984
  # Clay projections
  sg_clay_top_prj <- sg_clay_0_5cm%>%
    project(crs(climate_zones_sf))
  
  sg_clay_btm_prj <- sg_clay_15_30cm%>%
    project(crs(climate_zones_sf))
  
  # pH projections
  sg_pH_top_prj <- sg_pH_0_5cm%>%
    project(crs(climate_zones_sf))
  
  sg_pH_btm_prj <- sg_pH_15_30cm%>%
    project(crs(climate_zones_sf))
  
  
  #TODO slow step
  
  # Extracts soil grids clay and pH data from the MONet site locations
  # Clay
  sg_clay_monet_top <- terra::extract(sg_clay_top_prj, clay_loc_sf_top, fun=mean, na.rm=TRUE, bind=TRUE)
  # Extracts the values of the above 'SpatVector' object
  sg_clay_monet_top_values <- values(sg_clay_monet_top)%>%
    mutate(crop_roi_igh_clay_0.5cm = crop_roi_igh_clay_0.5cm/10)
  
  sg_clay_monet_btm <- terra::extract(sg_clay_btm_prj, clay_loc_sf_btm, fun=mean, na.rm=TRUE, bind=TRUE)
  sg_clay_monet_btm_values <- values(sg_clay_monet_btm)%>%
    mutate(crop_roi_igh_clay_15.30cm = crop_roi_igh_clay_15.30cm/10)
  
  # pH extraction
  sg_pH_monet_top <- terra::extract(sg_pH_top_prj, pH_loc_sf_top, fun=mean, na.rm=TRUE, bind=TRUE)
  sg_pH_monet_top_values <- values(sg_pH_monet_top)%>%
    mutate(crop_roi_igh_ph_0.5cm = crop_roi_igh_ph_0.5cm/10)
  
  sg_pH_monet_btm <- terra::extract(sg_pH_btm_prj, pH_loc_sf_btm, fun=mean, na.rm=TRUE, bind=TRUE)
  sg_pH_monet_btm_values <- values(sg_pH_monet_btm)%>%
    mutate(crop_roi_igh_ph_15.30cm = crop_roi_igh_ph_15.30cm/10)
  

  # 
  sg_clay_conus_top <- raster::mask(sg_clay_top_prj, conus_valid)%>%project(crs(clay_loc_sf_top))
  sg_clay_conus_btm <- raster::mask(sg_clay_btm_prj, conus_valid)%>%project(crs(clay_loc_sf_btm))

  sg_pH_conus_top <- raster::mask(sg_pH_top_prj, conus_valid)%>%project(crs(pH_loc_sf_top))
  sg_pH_conus_btm <- raster::mask(sg_pH_top_prj, conus_valid)%>%project(crs(pH_loc_sf_btm))


  soilgrids_by_zone <- function(soilgrids, climate_zones_conus_sf){
    
    # Convert the sf object (climate zones) to a terra SpatVector
    climate_zones_vect <- vect(climate_zones_conus_sf)
  
    # Mask clay content raster by each climate zone
    var_by_zone <- list()  # Create a list to store masked rasters for each zone
    
    climate_zone_names <- unique(climate_zones_conus_sf$Code)[1:21] 
    
    for (zone_name in climate_zone_names) {
      # Filter the specific climate zone
      single_zone <- climate_zones_vect[climate_zones_conus_sf$Code == zone_name, ]
      # Mask clay content to just this zone
      var_zone <- mask(crop(soilgrids, single_zone), single_zone)
      # Save the clay raster for this zone
      var_by_zone[[zone_name]] <- var_zone
    }
    
    # Create a list to store distinct clay content values for each zone
    values_by_zone <- list()
    
    for (zone_name in climate_zone_names) {
      # Get the clay content raster for this zone
      var_zone <- var_by_zone[[zone_name]]
      # Extract cell values as a vector
      var_values <- unique(values(var_zone, na.rm = TRUE))  # Remove NA values
      values_by_zone[[zone_name]] <- var_values         # Store in list
    }
    
    #TODO very slow ~few minutes
    var_zone_df <- data.frame(
      zone = names(values_by_zone),
      value = sapply(values_by_zone, function(x) paste(x, collapse = ", "))
    )
    
    var_long <- do.call(rbind, lapply(names(values_by_zone), function(zone_name) {
      data.frame(zone = zone_name, value = values_by_zone[[zone_name]])
    }))
    
    return(var_long)
  }
  
  clay_top_long <- soilgrids_by_zone(sg_clay_conus_top, climate_zones_conus_sf)
  clay_btm_long <- soilgrids_by_zone(sg_clay_conus_btm, climate_zones_conus_sf)

  pH_top_long <- soilgrids_by_zone(sg_pH_conus_top, climate_zones_conus_sf)
  pH_btm_long <- soilgrids_by_zone(sg_pH_conus_btm, climate_zones_conus_sf)

  save(clay_top_long, clay_btm_long,
       pH_top_long, clay_btm_long,
       sg_clay_monet_top_values, sg_clay_monet_btm_values,
       sg_pH_monet_top_values,sg_pH_monet_btm_values,
       file = "sg_data.RData")
} else {
  
  load("sg_data.RData")
  
}

```

# MONet datapoints not in soilgrids

```{r}

 # Clay content soil grids rasters
  sg_clay_0_5cm <- rast("./data/soilgrids/crop_roi_igh_clay_0-5cm.tif")


  sg_clay_top_prj <- sg_clay_0_5cm%>%
    project(crs(climate_zones_sf))
  
top_clay_test <- clay_loc_sf_top%>%
  mutate(color = if_else(sample == "1000S" & Clay_percent %in% c(9.99,14.52,18.00,7.98, 15.99, 20.57), "missing", "exist"))%>%
  filter(color == "missing")

ggplot()+
  tidyterra::geom_spatraster(data = sg_clay_top_prj)+
  geom_sf(data = top_clay_test, aes(color = color), color = "red")+
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  coord_sf(xlim = c(-80,-70),ylim = c(38,42))+
  theme_bw()+
  scale_fill_gradient(low = 'white', high = 'blue', na.value=NA)+
  ggtitle("MONet data points without Soilgrids data")

```

# 1-to-1 Comparison of Clay Content in MONet and Soilgrids

SoilGrids values are extracted at MONet sampling coordinates to enable direct point-to-point comparisons of pH and clay content of both datasets. The distribution of these points are compared to evaluated ability of direct geographic comparisons.

```{r 1-to-1 comparison clay, fig.dim=c(8,10)}

clay_top_1v1_comp <- sg_clay_monet_top_values%>%
  rename(MONet_clay = "Clay_percent", comp_clay = "crop_roi_igh_clay_0.5cm")%>%
  dplyr::select(MONet_clay, comp_clay)%>%
  pivot_longer(cols = c("MONet_clay", "comp_clay"), names_to = "Experiment", values_to = "clay_content_top")%>%
  mutate(Experiment = as.factor(Experiment))
  
clay_top <- ggplot(data = clay_top_1v1_comp)+
  geom_histogram(aes(x = clay_content_top, fill = Experiment), position = "identity", alpha = 0.8)+
  theme_bw()+
  ggtitle("MONet and Soilgrids Clay Content at MONet Sites (Top)")+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))


clay_btm_1v1_comp <- sg_clay_monet_btm_values%>%
  rename(MONet_clay = "Clay_percent", comp_clay = "crop_roi_igh_clay_15.30cm")%>%
  dplyr::select(MONet_clay, comp_clay)%>%
  pivot_longer(cols = c("MONet_clay", "comp_clay"), names_to = "Experiment", values_to = "clay_content_top")%>%
  mutate(Experiment = as.factor(Experiment))

clay_bottom <- ggplot(data = clay_btm_1v1_comp)+
  geom_histogram(aes(x = clay_content_top, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids Clay Content at MONet Sites (Bottom)")+
    scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))

ggarrange(clay_top, clay_bottom, nrow = 2, ncol = 1)

```

```{r 1-to-1 comparison pH, fig.dim = c(8,10)}
pH_top <- sg_pH_monet_top_values%>%
  rename(MONet_pH = "pH", comp_pH = "crop_roi_igh_ph_0.5cm")%>%
  dplyr::select(MONet_pH, comp_pH)%>%
  pivot_longer(cols = c("MONet_pH", "comp_pH"), names_to = "Experiment", values_to = "pH_top")%>%
  mutate(Experiment = as.factor(Experiment))%>%
  ggplot()+
  geom_histogram(aes(x = pH_top, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids pH Content at MONet Sites (Top)")+
    scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))


pH_bottom <- sg_pH_monet_btm_values%>%
  rename(MONet_pH = "pH", comp_pH = "crop_roi_igh_ph_15.30cm")%>%
  dplyr::select(MONet_pH, comp_pH)%>%
  pivot_longer(cols = c("MONet_pH", "comp_pH"), names_to = "Experiment", values_to = "pH_top")%>%
  mutate(Experiment = as.factor(Experiment))%>%
  ggplot()+
  geom_histogram(aes(x = pH_top, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids pH Content at MONet Sites (Bottom)")+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))

ggarrange(pH_top, pH_bottom, nrow = 2, ncol = 1)

```

```{r bind MONet and soilgrids data, echo=FALSE, warning=FALSE, message=FALSE}

clay_content_MONet_top <- clay_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "MONet")

clay_content_sg_top <- clay_top_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(clay_content_MONet_top$Climate))%>%
  rename(Clay_percent = "crop_roi_igh_clay_0.5cm")%>%
  dplyr::select(Climate, Clay_percent)%>%
  mutate(source = "soilGrids",
         Clay_percent = Clay_percent/10)

clay_MONet_sg_top <- bind_rows(clay_content_MONet_top, clay_content_sg_top)

pH_content_MONet_top <- pH_zones%>%
  left_join(climate_zone_mapping, by = c("Climate", "Code"))%>%
  filter(core_section == "TOP")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "MONet")

pH_content_sg <- pH_top_long%>%
  left_join(climate_zone_mapping, by = c("zone" = "Code"))%>%
  filter(Climate %in% unique(pH_content_MONet_top$Climate))%>%
  rename(pH = "crop_roi_igh_ph_0.5cm")%>%
  dplyr::select(Climate, pH)%>%
  mutate(source = "soilGrids",
         pH = pH/10)

pH_MONet_sg_top <- bind_rows(pH_content_MONet_top, pH_content_sg)

```

## Compare distributions of Clay and pH bewteen MONet and Soilgrids in aggregate and across climate zones

```{r plot comparisons}
# Boxplots of MONet and Soilgrids comparison by climate region

#TODO remove/increase sampling for final plotting

 plot_data_clay_top <- clay_MONet_sg_top %>%
    group_by(Climate, source) %>%
    slice_sample(n = 3000) %>%
    ungroup()
 
 sample_sizes_sg_top <- plot_data_clay_top %>%
   as.data.frame()%>%
   dplyr::select(Climate, source)%>%
   group_by(Climate, source) %>%
   summarise(n = n())%>%
   pivot_wider(names_from = "source", values_from = "n")%>%
   filter(MONet > 1)%>%
   mutate(axis_label = paste0(Climate, "\n", "MONet = ", MONet, ", Soilgrids = ", soilGrids))
 
 plot_data_clay_top%>%
   mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
   left_join(sample_sizes_sg_top, by = c("Climate"))%>%
   filter(!is.na(axis_label))%>%
   ggplot(aes(x = Clay_percent, y = axis_label, fill = Experiment, color = Experiment)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   scale_color_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   labs(
     title = "MONet and Soilgrids Clay Content by Climate Zone",
     x = "Clay Content (%)",
     y = "Climate Zone"
   )
  
 
 
 #####
  plot_data_pH_top <- pH_MONet_sg_top %>%
    group_by(Climate, source) %>%
    slice_sample(n = 3000) %>%
    ungroup()
 
 sample_sizes_pH_top <- plot_data_pH_top %>%
   as.data.frame()%>%
   dplyr::select(Climate, source)%>%
   group_by(Climate, source) %>%
   summarise(n = n())%>%
   pivot_wider(names_from = "source", values_from = "n")%>%
   filter(MONet > 1)%>%
   mutate(axis_label = paste0(Climate, "\n", "MONet = ", MONet, ", Soilgrids = ", soilGrids))
 
 plot_data_pH_top%>%
   mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_pH", "comp_pH")))%>%
   left_join(sample_sizes_pH_top, by = c("Climate"))%>%
   filter(!is.na(axis_label))%>%
   ggplot(aes(x = pH, y = axis_label, fill = Experiment, color = Experiment)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))+
   scale_color_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))+
   labs(
     title = "MONet and Soilgrids pH Content by Climate Zone",
     x = "pH",
     y = "Climate Zone"
   )
 

plot_data_clay_top%>%
  left_join(sample_sizes_pH_top, by = c("Climate"))%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
  ggplot(aes(x = Clay_percent, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet Clay Share Distribution",
      x = "Clay Content (%)"
      )


plot_data_pH_top%>%
  left_join(sample_sizes_pH_top, by = c("Climate"))%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_pH", "comp_pH")))%>%
  ggplot(aes(x = pH, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet pH Distribution",
      x = "pH"
      )


```

```{r}

```
