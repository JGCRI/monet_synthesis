---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris & Nathan J. Wiens"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
   # number_sections: TRUE
  pdf_document: 
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,           # Show code in output
  warning = FALSE,       # Hide warning messages
  message = FALSE,       # Hide package loading messages
  fig.width = 6,         # Default figure width
  fig.height = 6         # Default figure height
)
```

# Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). This script executes a series of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within Köppen climatic zones, 3) and the spatial distribution of soil clay content (Table 1). Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013).

## Prep our R Environment

### Load Packages

General data manipulation: `dplyr` and `tidyr`

Plotting: `ggplot2`, `ggpubr`, `ggpmisc`

Geographic data handling: `sf`, `terra`, `tidyterra`, `raster`, `tiff`

Precipitation and Temperature data: `geodata`

Biome plotting: `devtools`

```{r libraries, results = "hide"}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggpmisc)
library(sf)
library(terra)
library(tidyterra)
library(raster)
library(tiff)
library(geodata)
library(devtools)
library(BIOMEplot)

#install_github("kunstler/BIOMEplot")

```
Set up color palette for plotting
```{r graph colors, results = "hide"}

myColors <- c( "#000080","#4040A0","#8080C0", "#D6AA80", "#D98040", "#CC5500")
names(myColors) <- c("MONet_resp", "MONet_pH", "MONet_clay",
                     "comp_clay", "comp_pH", "comp_resp")

```

### Load Data (this can take a few minutes)

```{r Processed data, warning=FALSE, message=FALSE}

load("processed_data.Rdata")

if(!"processed_data.Rdata" %in% list.files()){
    print("Generate processed MONet data by sourcing MONetDataPreprocessing.R")
  #does this stop if she's not there?
} else {
    print("Processed data loaded, cheers!")
  }

```

### Load SoilGrids data (ditto)

```{r soilGrids data, warning=FALSE, message=FALSE}

load("sg_data.Rdata")

if(!"sg_data.RData" %in% list.files()){
  
  print("Generate processed SoilGrids data by sourcing MONetDataPreprocessing.R")
 
} else {
  print("SoilGrids data loaded, cheers!")
}

```

# 1. pH assessemnt within Koppen Climate Zones

## Extract Köppen Climate Zones for MONet data

This section loads a shapefile of the Köppen Climate Zones of North America, filters the climate zone shapefile to CONUS, and extracts the climate region for each data site location in MONet and 1000 soils. All spatial data are transformed into the target CRS to ensure accuracy.

If your data directory is missing the file below, download and move into the "data" folder.

[North American Köppen Climate Zones](https://www.cec.org/north-american-environmental-atlas/climate-zones-of-north-america)

### Load in North American Climate Zones

```{r load climate, warning=FALSE, message=FALSE, cache = TRUE, fig.dim=c(6,4), fig.align='center'}

# state codes for filtering to CONUS
state_abbreviations_conus <- c(
  "AL", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "ID", "IL", "IN", "IA", "KS", "KY",
  "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY",
  "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA",
  "WV", "WI", "WY"
)

# Read and ensure valid shapes for CONUS
conus_valid <- st_read("data/shapefiles/s_18mr25/s_18mr25.shp") %>%
  st_make_valid() %>%
  filter(STATE %in% state_abbreviations_conus) %>%
  st_transform("WGS84")

# Disable S2 processing to use GEOS for spatial operations
sf_use_s2(FALSE)

# Load the shapefile as an `sf` object
climate_zones_sf <- st_read("data/shapefiles/na_climatezones_shapefile/climatezones_shapefile/NA_ClimateZones/data/North_America_Climate_Zones.shp")%>%
  st_transform(crs(conus_valid))

# Create a mapping table for the 3 letter climate zone code to the full name
climate_zone_mapping <- climate_zones_sf%>%
  distinct(Code, Climate)

# Find intersection of climate zones and CONUS
climate_zones_conus_sf <- climate_zones_sf%>%
  st_intersection(st_union(conus_valid))

# 1000 soils project metadata
metadata_1000s <- read.csv("data/MONet/1000Soils_Metadata_Site_Mastersheet_v1.csv")

# Define the target CRS from the shapefile
target_crs <- st_crs(conus_valid)

# Convert coordinates to sf assuming the column names are 'Long' and 'Lat'
monet_rs_coords <- metadata_1000s %>%
  filter(Site_Code != "PUUM") %>% #Take out one
  st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  st_transform(target_crs)

ggplot() +
  geom_sf(data = climate_zones_conus_sf, aes(fill = Climate), color = "darkslategrey", alpha = 1) +
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  geom_sf(data = monet_rs_coords, size = 2.5, color = "white") +
  geom_sf(data = monet_rs_coords, size = 2, color = "#000080") +
  theme_bw()+
  labs(title = "CONUS Köppen Climate Zones of North America")+
  scale_color_discrete(drop=T)+
  theme(legend.position = "none")

```

## Plot distribution of pH in each region

```{r SG functions, include = FALSE}

sg_random_sample <- function(MONet_sg_top, sample_sizes_sg_top, seeds){
  
  MONet_data <- MONet_sg_top %>%
    filter(source == "MONet")
  
  for(seed in seeds){
    set.seed(seed)
    for(zone in unique(sample_sizes_sg_top$Climate)){
      
      n_samples <- sample_sizes_sg_top$MONet[sample_sizes_sg_top$Climate == zone]
    
      sampled_sg_zone <- MONet_sg_top%>%
        as.data.frame()%>%
        filter(Climate == zone, source != "MONet")%>%
        slice_sample(n = n_samples)%>%
        mutate(source = paste0("soilgrids_sample_", which(seed == seeds)))
      
      MONet_data <- bind_rows(MONet_data, sampled_sg_zone)
    }
  }
    return(MONet_data)
}

process_soil_data <- function(type, section, MONet_df, sg_df, climate_mapping_df, sg_column_name) {
  # Process MONet data
  MONet_data <- MONet_df %>%
    left_join(climate_mapping_df, by = c("Climate", "Code")) %>%
    filter(core_section == section) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "MONet")

  # Process SoilGrids data
  sg_data <- sg_df %>%
    left_join(climate_mapping_df, by = c("zone" = "Code")) %>%
    filter(Climate %in% unique(MONet_data$Climate)) %>%
    rename(!!type := sg_column_name) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "soilGrids",
           !!type := !!sym(type) / 10) # convert units

  # Combine MONet and SoilGrids data
  combined_data <- bind_rows(MONet_data, sg_data)
  return(combined_data)
}

```

```{r plot pH, fig.dim=c(6,9), fig.align='center', cache = TRUE, include = FALSE}

pH_MONet_sg_top <- process_soil_data(
  type = "pH",
  section = "TOP",
  MONet_df = pH_zones,
  sg_df = pH_top_long,
  climate_mapping_df = climate_zone_mapping,
  sg_column_name = "crop_roi_igh_ph_0.5cm"
)

pH_MONet_sg_btm <- process_soil_data(
  type = "pH",
  section = "BTM",
  MONet_df = pH_zones,
  sg_df = pH_btm_long,
  climate_mapping_df = climate_zone_mapping,
  sg_column_name = "crop_roi_igh_ph_15.30cm"
)

pH_samples <- sg_random_sample(pH_MONet_sg_top, sample_sizes_sg_top, seeds = c(1, 5, 10))

names(sample_colors) <- unique(pH_samples$source)

pH_samples%>%
   mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", source)))%>%
   left_join(sample_sizes_sg_top, by = c("Climate"))%>%
   filter(!is.na(axis_label))%>%
   ggplot(aes(x = pH, y = axis_label, fill = source, color = source)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   # scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   # scale_color_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   labs(
     title = "MONet and Soilgrids pH by Climate Zone",
     x = "pH",
     y = "Climate Zone"
   )+
  scale_y_discrete(labels = label_wrap_gen(30))+
  scale_fill_manual(name = "Experiment", values = sample_colors)+
  scale_color_manual(name = "Experiment", values = sample_colors)


```




# 2. Comparison of Soil Respiration relative to MAP and MAT

## Read in MONet respiration and SRDB data

Read in the experiment data and associated sample location files for the MONet and the SRDB soil respiration data and filter for observations located in the Continental United States (CONUS). The target coordinate reference system (CRS) is defined as WGS84 in this chunk and used to ensure spatial consistency through the rest of the markdown. The coordinates of MONet and SRDB locations are plotted for reference.

If your data directory is missing any of the files below, download them from their respective sources into the "data" folder.

[MONet soil respiration](https://zenodo.org/records/15328215)

[SRDB](https://github.com/bpbond/srdb)

[United States shapefile](https://www.weather.gov/gis/USStates)

```{r Comparison of Soil Respiration relative to MAP and MAT, cache = TRUE, include = FALSE, fig.dim=c(6,4)}

# read in site coordinates and data
monet_rs <- read.csv("data/MONet/1000S_processed_L2_summary.csv")
srdb <- read.csv("data/srdb/srdb-20250503a/srdb-data.csv")



# Define the target CRS from the shapefile
target_crs <- st_crs(conus_valid)

# Disable S2 processing to use GEOS for spatial operations
sf_use_s2(FALSE)

# Filter SRDB coordinates within shapefile boundaries
SRDB_coords <- srdb %>%
  dplyr::select(Record_number, Latitude, Longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
  st_transform(target_crs) %>%
  {.[rowSums(st_within(., conus_valid, sparse = FALSE)) > 0, ]}



# Plotting both sets of coordinates
ggplot() +
  geom_sf(data = conus_valid, fill = NA, color = "gray", linetype = "solid") +
  geom_sf(data = SRDB_coords, aes(color = 'SRDB Source'), size = 2, alpha = 0.7) +
  geom_sf(data = monet_rs_coords, aes(color = 'Monet RS Source'), size = 2, alpha = 0.7) +
  scale_color_manual(values = c('SRDB Source' = myColors[[6]], 'Monet RS Source' = myColors[[1]])) +
  theme_bw() +
  labs(title = "Map of Coordinates from MONet and SRDB",
       color = "Data Source") +
  theme(legend.position = "bottom")
```

## Extract Mean Annual Precipitation (MAP) and Mean Annual Temperature (MAT) for sample coordinates

Using the `geodata` package, \~1km\^2 gridded 10 minute precipitation and average temperature data from 1970-2000 is downloaded and and extracted at the MONet and SRDB sample sites. These data are then used to create timeseries of MAP and MAP for each sample location. A selection of sites are plotted for illustration.

```{r Extract MAP and MAT for samples, cache = TRUE, include = FALSE}
# Function to extract climate data: precipitation and temperature
process_climate_data <- function(coords_df, ID_column) {
  coords_extracted <- st_coordinates(coords_df)
  coords_data <- tibble(place = coords_df[[ID_column]], lon = coords_extracted[, "X"], lat = coords_extracted[, "Y"])
  coords_data$ID <- seq_len(nrow(coords_data))

  # WorldClim data extraction
  tavg <- worldclim_global("tavg", "10", "data/worldclim_data/")
  tprec <- worldclim_global("prec", "10", "data/worldclim_data/")

  tavg_extracted <- terra::extract(tavg, coords_data[, c("lon", "lat")])
  tprec_extracted <- terra::extract(tprec, coords_data[, c("lon", "lat")])

  # Calculate MAT and MAP
  coords_data <- coords_data %>%
    mutate(MAT = rowMeans(tavg_extracted[, -1], na.rm = TRUE),
           MAP = rowMeans(tprec_extracted[, -1], na.rm = TRUE) * 12) # Convert to annual precipitation

  # Reshape monthly precipitation data
  monthly_prec <- pivot_longer(tprec_extracted, -ID, names_to = "name", values_to = "precipitation")
  
  # Reshape monthly temperature data
  monthly_temp <- pivot_longer(tavg_extracted, -ID, names_to = "name", values_to = "temperature")

  monthly_prec$month <- as.numeric(gsub("wc2.1_10m_prec_", "", monthly_prec$name))
  monthly_temp$month <- as.numeric(gsub("wc2.1_10m_tavg_", "", monthly_temp$name))

  monthly_joined_prec <- monthly_prec %>% mutate(place = coords_data$place[monthly_prec$ID])
  monthly_joined_temp <- monthly_temp %>% mutate(place = coords_data$place[monthly_temp$ID])

  return(list(monthly_prec = monthly_joined_prec, monthly_temp = monthly_joined_temp, annual = coords_data))
}

# Plot function for climatology
plot_climatology <- function(monthly_data, title, y_label, value_column) {
  ggplot(monthly_data, aes(month, !!sym(value_column), color = factor(place))) +
    geom_line() +
    labs(title = title, y = y_label, color = "Place") +
    theme_bw() +
    theme(legend.position = "bottom")
}

# Process monet_rs_coords, subset 18 and plot
monet_data <- process_climate_data(monet_rs_coords, "Site_Code")
set.seed(42)
sampled_places_monet <- monet_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_monet <- monet_data$monthly_prec %>% filter(place %in% sampled_places_monet$place)
sampled_temp_monet <- monet_data$monthly_temp %>% filter(place %in% sampled_places_monet$place)

p_monet_prec <- plot_climatology(sampled_prec_monet, "Precipitation for Sampled Monet RS Coords", "Precipitation", "precipitation")
p_monet_temp <- plot_climatology(sampled_temp_monet, "Temperature for Sampled Monet RS Coords", "Air temperature", "temperature")
print(p_monet_prec)
print(p_monet_temp)

# Process SRDB_coords, subset 18 and plot
srdb_data <- process_climate_data(SRDB_coords, "Record_number")
set.seed(42)
sampled_places_srdb <- srdb_data$annual %>% distinct(place) %>% sample_n(18)
sampled_prec_srdb <- srdb_data$monthly_prec %>% filter(place %in% sampled_places_srdb$place)
sampled_temp_srdb <- srdb_data$monthly_temp %>% filter(place %in% sampled_places_srdb$place)

p_srdb_prec <- plot_climatology(sampled_prec_srdb, "Precipitation for Sampled SRDB Coords", "Precipitation", "precipitation")
p_srdb_temp <- plot_climatology(sampled_temp_srdb, "Temperature for Sampled SRDB Coords", "Air temperature", "temperature")
print(p_srdb_prec)
print(p_srdb_temp)

```

```{r MONet site Biomes, fig.align='center'}

BIOMEplot::plot_biome(add.legend = TRUE, add.number = FALSE)
points(monet_data$annual$MAP/10, monet_data$annual$MAT, col = "blue", pch = 19)
title("MONet site Biomes by MAP and MAT")

```

## Identify relationship between soil respiration in SRDB to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on soil respiration.

Soil respiration is converted from annual soil respiration to mgC/gSoil/day using the following assumptions and parameters:

-   **Bulk density (**$\rho$): 1.85 g/cm³ (mass of soil per unit volume).
-   **Effective soil depth (**$d$): **10 cm** as a common depth for soil respiration studies.
-   **Area conversion**: 1 m² = 10,000 cm².

Using the equation:

$$\text{mg C g⁻¹ soil day⁻¹} = \left( \frac{\text{g C m² yr⁻¹} \times 1}{365 \times 185,000} \right) \times 1,000$$

For a detailed explanation of assumptions and the conversion process see `SRDB_to_mgC_gSoil_day.txt`

```{r SRDB MAP and MAT relationship, cache = TRUE, include = TRUE}

##
###
####
# REMOVE?
###
##
#

# Select annual respiration from SRDB dadta
srdb %>%
  dplyr::select(Rs_annual, Record_number) -> srdb_slim

# Rename the 'place' column in srdb_data$annual to match 'Record_number' in srdb_slim
srdb_annual <- srdb_data$annual %>%
  rename(Record_number = place)

# Combine datasets by 'Record_number'
SRDB_data <- srdb_slim %>%
  inner_join(srdb_annual, by = "Record_number")

#TODO Rs conversion here
# Convert Rs from Rs annual to mgC/gSoil/day
bulk_density_g_cm2 <- 1.85
effective_soil_depth_cm <- 10

conversion_factor = 1000 * (1/(365 * bulk_density_g_cm2 * 10^5))

SRDB_mg_co2_c_g_soil_day <- SRDB_data%>%
  mutate(Rs_mg_co2_g_24h = Rs_annual * conversion_factor)


# Linear regression model to test the effect of MAP and MAT on Rs_annual
SRDB_model <- lm(Rs_annual ~ MAP + MAT, data = SRDB_mg_co2_c_g_soil_day)
summary(SRDB_model)

# Print regression summary
print(summary(SRDB_model))

# Plot Rs_annual vs MAP
plot_MAP <- ggplot(SRDB_mg_co2_c_g_soil_day, aes(x = MAP, y = Rs_mg_co2_g_24h)) +
  geom_point(color = myColors["comp_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Effect of MAP on Rs (mg_co2_g_24h)",
       x = "Mean Annual Precipitation (MAP)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))

# Plot Rs_annual vs MAT
plot_MAT <- ggplot(SRDB_mg_co2_c_g_soil_day, aes(x = MAT, y = Rs_mg_co2_g_24h)) +
  geom_point(color = myColors["comp_resp"], alpha = 0.5) +
  geom_smooth(method = "lm", col = "red") +
  labs(title = "Effect of MAT on Rs (mg_co2_g_24h)",
       x = "Mean Annual Temperature (MAT)",
       y = "Annual Soil Respiration (Rs_annual)") +
  theme_bw()+
  theme(axis.title.y = element_text(size = 7))

```

## Identify relationship between soil respiration in MONet to MAP and MAT

With the calculated MAP and MAT, use a simple linear model to test the influence of MAP and MAT on annual soil respiration.

```{r MONet MAP and MAT respiration relationship, include = FALSE}

# Select soil respiration from MONet data
monet_rs %>%
  dplyr::select(Sample_Name, respiration_ppm_co2_c,
         respiration_mg_co2_c_g_soil_day_24hour,
         respiration_mg_co2_c_g_soil_day_96hour) -> monet_slim

# Function to separate and add metadata from Sample_Name
extract_metadata <- function(monet_slim) {
  monet_slim %>%
    mutate(
      Site_Code = sapply(strsplit(Sample_Name, "_"), `[`, 3),
      Core_Section = sapply(strsplit(Sample_Name, "_"), `[`, 4)
    )
}

# Extract metadata
monet_rs_metadata <- extract_metadata(monet_slim)

# Integrate this with the annual climate data (MAT, MAP) using Site_Code as key
combined_monet <- monet_rs_metadata %>%
  inner_join(monet_data$annual, by = c("Site_Code" = "place"))

```


To represent a single soil respiration data point for each MONet sample core, an index was developed which takes the top and bottom core sample into account. Given that the majority of molecular activity take place in the top layers of soil, the top sample is weighted .65 and the bottom sample .45. The one and four day respiration rates are weighted equally. 

Index = 0.5 × [ (0.65 × (24 hr Top + 96 hr Top)) + (0.35 × (24 hr Bottom + 96 hr Bottom)) ]

## Impact of MAP and MAT on Soil Respiration by source

```{r Rs Analysis, fig.dim=c(6,4), fig.align='center'}

#calculate index and prep for combining with SRDB
rs_index_results <- combined_monet %>%
  dplyr::select(ID,
                respiration_mg_co2_c_g_soil_day_24hour,
                respiration_mg_co2_c_g_soil_day_96hour,
                Site_Code, Core_Section, MAT, MAP) %>%
  na.omit() %>%
  group_by(ID) %>%
  mutate(weighted_time_respiration = (1/3) * respiration_mg_co2_c_g_soil_day_24hour + (2/3) * respiration_mg_co2_c_g_soil_day_96hour) %>%
  group_by(Site_Code) %>%
  summarise(
    rs_index = sum( case_when(
        Core_Section == "TOP" ~ 0.65 * weighted_time_respiration,
        Core_Section == "BTM" ~ 0.35 * weighted_time_respiration),
      na.rm = TRUE),
    .groups = "drop") %>%
  left_join(combined_monet %>% distinct(Site_Code, MAT, MAP), by = "Site_Code") %>%
  mutate(
    respiration_rate = rs_index,
    source = "MONet"
  ) %>%
  dplyr::select(respiration_rate, MAT, MAP, source)

srdb %>%
  dplyr::select(Rs_annual, Record_number) -> srdb_slim

# Rename the 'place' column in srdb_data$annual to match 'Record_number' in srdb_slim
srdb_annual <- srdb_data$annual %>%
  rename(Record_number = place)

# Combine datasets by 'Record_number'
combined_SRDB <- srdb_slim %>%
  inner_join(srdb_annual, by = "Record_number")

#convert
set.seed(42)
converted_srdb <- combined_SRDB %>%
  mutate(
    Rs_daily_mg_per_g_soil = 1000 * (Rs_annual / (1.25 * 10 * 10000 * 365))
    # Conversion formula
  ) %>%
  na.omit() %>%
  filter(MAT > 8 & MAT < 16.5 & MAP > 200 & MAP < 1230) %>%
  #filtering to climate range of MONet
  slice_sample(n = 64) %>% #4x MONet sample size
  mutate(
    respiration_rate = Rs_daily_mg_per_g_soil,
    source = "SRDB"
  ) %>%
  dplyr::select(respiration_rate, MAT, MAP, source)

### Step 3: Combine the Two Dataframes
combined_data_for_model <- bind_rows(converted_srdb, rs_index_results)

cd4m <- combined_data_for_model %>%
  group_by(source) %>%
  mutate(respiration_z = (respiration_rate - mean(respiration_rate)) / sd(respiration_rate)) %>%
  ungroup()

### Step 4: Linear Model Testing
model1 <- lm(respiration_z ~ source + MAT + MAP, data = cd4m)
summary(model1)

### Step 5: Reshape Data and Facetted Plot
cd4m %>%
  pivot_longer(cols = c(MAT, MAP), names_to = "climate_parameter", values_to = "climate_value") %>%
  ggplot(aes(x = climate_value, y = respiration_z)) +
  geom_point(aes(color = source), alpha = 0.7, size = 3) + # Scatter plot
  geom_smooth(method = "lm", se = FALSE, aes(color = source)) + # Regression line
  facet_wrap(climate_parameter ~ ., scales = "free_x") + # Facet by source and climate_parameter
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"),
        group = source,
        color = source),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) + # Regression equation and R²
  labs(
    title = "Rs vs Climate by Data Source",
    x = "Climate Parameter",
    y = "Z-score Respiration Rate (mg C per g soil per day)"
  ) +
  scale_color_manual(values = c("SRDB" = "#0072B2", "MONet" = "#D55E00")) +
  theme_minimal()

model2 <- lm(respiration_rate ~ source + MAT + MAP, data = cd4m)
summary(model2)

cd4m %>%
  pivot_longer(cols = c(MAT, MAP), names_to = "climate_parameter", values_to = "climate_value") %>%
  ggplot(aes(x = climate_value, y = respiration_rate)) +
  geom_point(aes(color = source), alpha = 0.7, size = 3) + # Scatter plot
  geom_smooth(method = "lm", se = FALSE, aes(color = source)) + # Regression line
  facet_wrap(source ~ climate_parameter, scales = "free") + # Facet by source and climate_parameter
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"),
        group = source,
        color = source),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) + # Regression equation and R²
  labs(
    title = "Rs vs Climate by Data Source",
    x = "Climate Parameter",
    y = "NOTE VARIABLE SCALE \n Respiration Rate (mg C per g soil per day)"
  ) +
  scale_color_manual(values = c("SRDB" = "#0072B2", "MONet" = "#D55E00")) +
  theme_minimal()


```



# MONet datapoints not in soilgrids

This analysis identified 6 MONet sample sites in locations with incomplete data in the soil grids dataset. Even though these locations are considered as urban sites and not recorded in soil grids, having data on the soil biogeochemistry composition can offer insights into soil health and processes in urban environments. The 6 locations were made up of 3 site in Baltimore, MD, 2 in Philadelphia, PA, and 1 in College Park, MD:

-   Northwest Baltimore Base of Slope Adelphi, MD
-   Northwest Baltimore Mid Slope Adelphi, MD
-   Northwest Baltimore Top of Slope Adelphi, MD
-   Urban CZO (College Park, MD)
-   Winters Lane Lower Soil Pit (Philadelphia, PA)
-   Winters Lane Upper Soil Pit (Philadelphia, PA)

```{r MONet not in Soilgrids, fig.dim=c(6,5), fig.align='center', cache = TRUE}
 # Clay content soil grids rasters
sg_clay_0_5cm <- rast("./data/soilgrids/crop_roi_igh_clay_0-5cm.tif")

sg_clay_top_prj <- sg_clay_0_5cm%>%
    project(crs(climate_zones_sf))
   
sg_clay_15_30cm <- rast("./data/soilgrids/crop_roi_igh_clay_15-30cm.tif")

sg_clay_btm_prj <- sg_clay_15_30cm%>%
    project(crs(climate_zones_sf))

monet_clay_missing <- rbind(sg_clay_monet_top_values%>%
                              filter(is.na(crop_roi_igh_clay_0.5cm))%>%
                              dplyr::select(Clay_percent, source, core_section, sample),
                            sg_clay_monet_btm_values%>%
                              filter(is.na(crop_roi_igh_clay_15.30cm))%>%
                              dplyr::select(Clay_percent, source, core_section, sample))%>%
  mutate(missing = TRUE)
  

top_clay_test <- clay_loc_sf_top%>%
  left_join(monet_clay_missing, by = c("core_section", "Clay_percent", "source", "sample"))%>%
  filter(missing == TRUE)%>%
    separate(sample, into = c("prj", "Site_Code"))%>%
    left_join(metadata_1000s, by = c("Site_Code"))
  


ggplot()+
  tidyterra::geom_spatraster(data = sg_clay_top_prj/10)+
  geom_sf(data = conus_valid, color = "grey", alpha = 0.3)+
  geom_sf(data = top_clay_test, color = "black", size = 5)+
  geom_sf(data = top_clay_test, aes(color=Site_Code), size =4, alpha = 0.8)+
  coord_sf(xlim = c(-78,-74),ylim = c(38,41))+
  theme_bw()+
  scale_fill_gradient(low = 'white', high = 'blue', na.value=NA)+
  labs(title = "MONet data points without Soilgrids data")

```

# 1-to-1 Comparison of Clay Content in MONet and Soilgrids

SoilGrids values are extracted at MONet sampling coordinates to enable direct point-to-point comparisons of pH and clay content of both datasets. The distribution of these points are compared to evaluated ability of direct geographic comparisons.

```{r 1-to-1 comparison clay, fig.dim=c(8,8), fig.align='center', cache = TRUE}

clay_top_1v1_comp <- sg_clay_monet_top_values%>%
  rename(MONet_clay = "Clay_percent", comp_clay = "crop_roi_igh_clay_0.5cm")%>%
  dplyr::select(MONet_clay, comp_clay)%>%
  pivot_longer(cols = c("MONet_clay", "comp_clay"), names_to = "Experiment", values_to = "clay_content_top")%>%
  mutate(Experiment = as.factor(Experiment))
  
clay_top <- ggplot(data = clay_top_1v1_comp)+
  geom_histogram(aes(x = clay_content_top, fill = Experiment), position = "identity", alpha = 0.8)+
  theme_bw()+
  ggtitle("MONet and Soilgrids Clay Content at MONet Sites (Top)")+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))

clay_btm_1v1_comp <- sg_clay_monet_btm_values%>%
  rename(MONet_clay = "Clay_percent", comp_clay = "crop_roi_igh_clay_15.30cm")%>%
  dplyr::select(MONet_clay, comp_clay)%>%
  pivot_longer(cols = c("MONet_clay", "comp_clay"), names_to = "Experiment", values_to = "clay_content_top")%>%
  mutate(Experiment = as.factor(Experiment))

clay_bottom <- ggplot(data = clay_btm_1v1_comp)+
  geom_histogram(aes(x = clay_content_top, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids Clay Content at MONet Sites (Bottom)")+
    scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))

ggarrange(clay_top, clay_bottom, nrow = 2, ncol = 1)

```

```{r 1-to-1 comparison pH, fig.dim = c(8,8), fig.align='center', cache = TRUE}
pH_top_1v1_comp <- sg_pH_monet_top_values%>%
  rename(MONet_pH = "pH", comp_pH = "crop_roi_igh_ph_0.5cm")%>%
  dplyr::select(MONet_pH, comp_pH)%>%
  pivot_longer(cols = c("MONet_pH", "comp_pH"), names_to = "Experiment", values_to = "pH_top")%>%
  mutate(Experiment = as.factor(Experiment))

pH_top <- pH_top_1v1_comp%>%
  ggplot()+
  geom_histogram(aes(x = pH_top, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids pH Content at MONet Sites (Top)")+
    scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))

pH_btm_1v1_comp <- sg_pH_monet_btm_values%>%
  rename(MONet_pH = "pH", comp_pH = "crop_roi_igh_ph_15.30cm")%>%
  dplyr::select(MONet_pH, comp_pH)%>%
  pivot_longer(cols = c("MONet_pH", "comp_pH"), names_to = "Experiment", values_to = "pH_btm")%>%
  mutate(Experiment = as.factor(Experiment))

pH_bottom <- pH_btm_1v1_comp%>%
  ggplot()+
  geom_histogram(aes(x = pH_btm, fill = Experiment), position = "identity", alpha = 0.6)+
  theme_bw()+
  ggtitle("MONet and Soilgrids pH Content at MONet Sites (Bottom)")+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))

ggarrange(pH_top, pH_bottom, nrow = 2, ncol = 1)

```

```{r bind MONet and soilgrids data, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, cache.lazy=FALSE}
process_soil_data <- function(type, section, MONet_df, sg_df, climate_mapping_df, sg_column_name) {
  # Process MONet data
  MONet_data <- MONet_df %>%
    left_join(climate_mapping_df, by = c("Climate", "Code")) %>%
    filter(core_section == section) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "MONet")

  # Process soilGrids data
  sg_data <- sg_df %>%
    left_join(climate_mapping_df, by = c("zone" = "Code")) %>%
    filter(Climate %in% unique(MONet_data$Climate)) %>%
    rename(!!type := sg_column_name) %>%
    dplyr::select(Climate, !!type) %>%
    mutate(source = "soilGrids",
           !!type := !!sym(type) / 10) # convert units

  # Combine MONet and soilGrids data
  combined_data <- bind_rows(MONet_data, sg_data)
  return(combined_data)
}

clay_MONet_sg_top <- process_soil_data(
  type = "Clay_percent",
  section = "TOP",
  MONet_df = clay_zones,
  sg_df = clay_top_long,
  climate_mapping_df = climate_zone_mapping,
  sg_column_name = "crop_roi_igh_clay_0.5cm"
)

clay_MONet_sg_btm <- process_soil_data(
  type = "Clay_percent",
  section = "BTM",
  MONet_df = clay_zones,
  sg_df = clay_btm_long,
  climate_mapping_df = climate_zone_mapping,
  sg_column_name = "crop_roi_igh_clay_15.30cm"
)


```


## Compare distributions of Clay and pH bewteen MONet and Soilgrids in aggregate and across climate zones

The following MONet sites were excluded from the following analysis since there was only one sample available for the climate zone:

-   Anza Borrego Desert State (Hot Desert Climate)\
-   Santa Rita Experimental Range NEON (Hot Semi-Arid Climate)\
-   Northern Great Plains Research Laboratory NEON (Humid Continental Hot Summers with Dry Winters)\
-   Dakota Coteau Field Site NEON (Humid Continental Mild Summer with Dry Winters)\
-   Peterson Farm (Temperate Oceanic Climate)\
-   Beaver Creek, Washington (Warm-Summer Mediterranean Climate)

For each region with more than one MONet site, 1,000 observations of Soilgrids data were randomly sampled to illustrate the distribution of pH and clay content in each climate zone.

```{r plot comparisons across zones, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE}
# Boxplots of MONet and Soilgrids comparison by climate region

process_plot_data <- function(soil_data, n_samples = 1000){
  plot_data <- soil_data %>%
    group_by(Climate, source) %>%
    slice_sample(n = 1000) %>%
    ungroup()
  
  sample_sizes <- plot_data %>%
   as.data.frame()%>%
   dplyr::select(Climate, source)%>%
   group_by(Climate, source) %>%
   summarise(n = n())%>%
   pivot_wider(names_from = "source", values_from = "n")%>%
   filter(MONet > 1)%>%
   mutate(axis_label = paste0(Climate, "\n", "MONet = ", MONet, ", Soilgrids = ", soilGrids))
  
  plot_data_samples <- left_join(plot_data, sample_sizes, by = "Climate")
  
  return(plot_data_samples)
}

plot_clay_top <- process_plot_data(clay_MONet_sg_top)

plot_clay_btm <- process_plot_data(clay_MONet_sg_btm)

plot_pH_top <- process_plot_data(pH_MONet_sg_top)

plot_pH_btm <- process_plot_data(pH_MONet_sg_btm)


climate_zones_one_site <- clay_MONet_sg_top %>%
   as.data.frame()%>%
   dplyr::select(Climate, source)%>%
   group_by(Climate, source) %>%
   summarise(n = n())%>%
   pivot_wider(names_from = "source", values_from = "n")%>%
   filter(MONet <= 1)%>%
   dplyr::select(Climate)

monet_pH_coord <- read.csv("data/MONet/pH/processed_data/Coordinates.csv")

site_locations <- pH_zones%>%
  filter(Climate %in% climate_zones_one_site$Climate)%>%
  mutate(Site_Code = sub("1000S_","", sample),,
         sample = as.integer(sample))%>%
  left_join(metadata_1000s, by = c("Site_Code"))%>%
  left_join(monet_pH_coord, by = c("proposal_id", "sample" = "sampling_set"))%>%
  dplyr::select(Climate, Site_Name_Long, geo_loc_name)
 

```

```{r plot comparisons, fig.dim=c(10,10), echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE}

generate_violin_plots <- function(plot_data, value_col, source_mapping, title, x_label){
  plot_data%>%
    mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
    filter(!is.na(axis_label))%>%
    ggplot(aes(x = !!sym(value_col), y = axis_label, fill = Experiment, color = Experiment)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   scale_fill_manual(name = "Experiment", values = myColors, labels = source_mapping)+
   scale_color_manual(name = "Experiment", values = myColors, labels = source_mapping)+
   labs(
     title = title,
     x = x_label,
     y = "Climate Zone"
   )+
  scale_y_discrete(labels = label_wrap_gen(30))
}

generate_violin_plots(plot_data = plot_clay_top,
                      value_col = "Clay_percent", 
                      source_mapping = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"),
                      title = "MONet and Soilgrids Clay Content by Climate Zone (Top sample)", 
                      x_label = "Clay Content (%)")

generate_violin_plots(plot_data = plot_clay_btm,
                      value_col = "Clay_percent", 
                      source_mapping = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"),
                      title = "MONet and Soilgrids Clay Content by Climate Zone (Bottom sample)", 
                      x_label = "Clay Content (%)")

generate_violin_plots(plot_data = plot_pH_top,
                      value_col = "pH", 
                      source_mapping = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"),
                      title = "MONet and Soilgrids pH by Climate Zone (Top sample)", 
                      x_label = "pH")

generate_violin_plots(plot_data = plot_pH_btm,
                      value_col = "pH", 
                      source_mapping = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"),
                      title = "MONet and Soilgrids pH by Climate Zone (Bottom sample)", 
                      x_label = "pH")
 
 
```

## Randomly sample soilgrids points at same frequency of MONet sites for each climate zone

```{r random sample plottting, fig.dim=c(10,10), echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE }

sample_sizes_sg_top <- plot_clay_top %>%
   as.data.frame()%>%
   dplyr::select(Climate, source)%>%
   group_by(Climate, source) %>%
   summarise(n = n())%>%
   pivot_wider(names_from = "source", values_from = "n")%>%
   filter(MONet > 1)%>%
   mutate(soilGrids = MONet)%>%
   mutate(axis_label = paste0(Climate, "\n", "MONet = ", MONet, ", Soilgrids = ", soilGrids))

sg_random_sample <- function(MONet_sg_top, sample_sizes_sg_top, seeds){
  
  MONet_data <- MONet_sg_top %>%
    filter(source == "MONet")
  
  for(seed in seeds){
    set.seed(seed)
    for(zone in unique(sample_sizes_sg_top$Climate)){
      
      n_samples <- sample_sizes_sg_top$MONet[sample_sizes_sg_top$Climate == zone]
    
      sampled_sg_zone <- MONet_sg_top%>%
        as.data.frame()%>%
        filter(Climate == zone, source != "MONet")%>%
        slice_sample(n = n_samples)%>%
        mutate(source = paste0("soilgrids_sample_", which(seed == seeds)))
      
      MONet_data <- bind_rows(MONet_data, sampled_sg_zone)
    }
  }
    return(MONet_data)
}


clay_samples <- sg_random_sample(clay_MONet_sg_top, sample_sizes_sg_top, seeds = c(1, 5, 10))

pH_samples <- sg_random_sample(pH_MONet_sg_top, sample_sizes_sg_top, seeds = c(1, 5, 10))


sample_colors <- c("#8080C0", "#D6AA80", "#D98040", "#CC5500")
names(sample_colors) <- unique(clay_samples$source)

clay_samples%>%
   mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", source)))%>%
   left_join(sample_sizes_sg_top, by = c("Climate"))%>%
   filter(!is.na(axis_label))%>%
   ggplot(aes(x = Clay_percent, y = axis_label, fill = source, color = source)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   # scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   # scale_color_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   labs(
     title = "MONet and Soilgrids Clay Content by Climate Zone",
     x = "Clay Content (%)",
     y = "Climate Zone"
   )+
  scale_y_discrete(labels = label_wrap_gen(30))+
  scale_fill_manual(name = "Experiment", values = sample_colors)+
  scale_color_manual(name = "Experiment", values = sample_colors)
  

names(sample_colors) <- unique(pH_samples$source)

pH_samples%>%
   mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", source)))%>%
   left_join(sample_sizes_sg_top, by = c("Climate"))%>%
   filter(!is.na(axis_label))%>%
   ggplot(aes(x = pH, y = axis_label, fill = source, color = source)) +
      geom_violin(alpha = 0.7, 
                  position = position_dodge(width = 0.8),
                  scale = "width") +  # Equal widths regardless of sample size
      geom_boxplot(fill = NA,
                   position = position_dodge(width = 0.8),
                   outlier.shape = NA)+
      theme_bw()+
   # scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   # scale_color_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
   labs(
     title = "MONet and Soilgrids pH by Climate Zone",
     x = "pH",
     y = "Climate Zone"
   )+
  scale_y_discrete(labels = label_wrap_gen(30))+
  scale_fill_manual(name = "Experiment", values = sample_colors)+
  scale_color_manual(name = "Experiment", values = sample_colors)


```

```{r Plot histograms, fig.dim=c(8,6), fig.align='center', echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, cache.lazy = FALSE}

clay_top <- clay_MONet_sg_top%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
  ggplot(aes(x = Clay_percent, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet Clay Share Distribution (Top sample)",
      x = "Clay Content (%)"
      )

clay_btm <- clay_MONet_sg_btm%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_clay", "comp_clay")))%>%
  ggplot(aes(x = Clay_percent, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_clay" = "Soilgrids", "MONet_clay" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet Clay Share Distribution (Bottom sample)",
      x = "Clay Content (%)"
      )


pH_top <- pH_MONet_sg_top%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_pH", "comp_pH")))%>%
  ggplot(aes(x = pH, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet pH Distribution (Top sample)",
      x = "pH"
      )

pH_btm <- pH_MONet_sg_btm%>%
  mutate(Experiment = as.factor(if_else(source == "MONet", "MONet_pH", "comp_pH")))%>%
  ggplot(aes(x = pH, fill = Experiment))+
  geom_histogram(mapping = aes(y = after_stat(density)), position = "identity", alpha = 0.7)+
  theme_bw()+
  scale_fill_manual(name = "Experiment", values = myColors, labels = c("comp_pH" = "Soilgrids", "MONet_pH" = "MONet"))+
  #facet_wrap(~axis_label, scales = "free_y")+
    labs(
      title = "Soilgrids and MONet pH Distribution (Bottom sample)",
      x = "pH"
      )

ggarrange(clay_top, clay_btm, nrow = 2, ncol = 1)

ggarrange(pH_top, pH_btm, nrow = 2, ncol = 1)


```

# 3. Spatial Comparison of Clay Content

```{r Spatial comparison, fig.dim = c(8,8), fig.align='center', echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, cache.lazy = FALSE}


#TODO remove once new r_data generated
sg_clay_conus_top <- raster::mask(sg_clay_top_prj, conus_valid)%>%project(crs(conus_valid))
sg_clay_conus_btm <- raster::mask(sg_clay_btm_prj, conus_valid)%>%project(crs(conus_valid))

p1 <- ggplot()+
  geom_spatraster(data = sg_clay_conus_top/10)+
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  geom_sf(data = clay_loc_sf_top, aes(fill = Clay_percent), colour = "black", size =3)+
  geom_sf(data = clay_loc_sf_top, aes(color = Clay_percent), size =2)+
  theme_bw()+
  scale_fill_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85))+
  scale_color_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85), guide = "none")+
  labs(
    title = "Spatial Comparison of MONet Clay Content to Soilgrids (Top sample)",
    fill = "% Clay")



p2 <- ggplot()+
  tidyterra::geom_spatraster(data = sg_clay_conus_btm/10)+
  geom_sf(data = conus_valid, color = "black", alpha = 0.3)+
  geom_sf(data = clay_loc_sf_btm, aes(fill = Clay_percent), colour = "black", size =3)+
  geom_sf(data = clay_loc_sf_btm, aes(color = Clay_percent), size =2)+
  theme_bw()+
  scale_fill_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85))+
  scale_color_gradient(low = 'white', high = 'blue', na.value=NA, limits = c(0,85), guide = "none")+
  labs(
    title = "Spatial Comparison of MONet Clay Content to Soilgrids (Bottom sample)",
    fill = "% Clay")

ggarrange(p1, p2, nrow = 2, ncol = 1)



```
