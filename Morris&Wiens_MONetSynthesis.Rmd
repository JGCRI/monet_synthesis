---
title: "Morris&Wiens_MONetSynthesis"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

This R markdown is designed to be a guide for systematically comparing and integrating MONet soil data with publicly available datasets such as SoilGrids (Hengl et al., 2017) and the Soil Respiration Database (SRDB, Jian et al., 2021). We will execute a set of three comparative and statistical analyses involving 1) soil respiration relative to mean annual precipitation (MAP) and mean annual temperature (MAT), 2) assessments of soil pH within KÃ¶ppen climatic zones, 3) and the spatial distribution of soil clay content (Table 1). Due to differences in the spatial scale of global data products verses a nationally focused effort such as MONet, the response of soil properties to known drivers will be our metric of comparison (Collier et al., 2018; Shao et al., 2013). For an upscaled comparison of soil clay content,

```{r libraries, results = "hide"}
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(terra)
library(raster)

```

## Reading pH and Clay content data from MONet

```{r pressure}
# set data_dir to a path to your data folder for MONet data
data_dir <- "C:/Users/wien002/OneDrive - PNNL/Desktop/MONet/"

# read in site coordinates
monet_pH_coord <- read.csv(paste0(data_dir, "data/pH/processed_data/Coordinates.csv"))
monet_clay_coord <- read.csv(paste0(data_dir, "data/clay/processed_data/Coordinates.csv"))

# read in site data
monet_pH_data <- read.csv(paste0(data_dir, "data/pH/processed_data/Soil_BioChemical_properties.csv"))
monet_clay_data <- read.csv(paste0(data_dir, "data/clay/processed_data/Soil_BioChemical_properties.csv"))

```


## Join pH and Clay site locations to data

```{r}

monet_pH_loc <- monet_pH_data%>%
  separate(Sample_Name, into = c("proposal_id", "sampling_set", "sample"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sampling_set = as.numeric(sampling_set))%>%
  left_join(monet_pH_coord, by = c("proposal_id", "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude))

monet_clay_loc <- monet_clay_data%>%
  separate(Sample_Name, into = c("proposal_id", "sampling_set", "sample"))%>%
  mutate(proposal_id = as.numeric(proposal_id),
         sampling_set = as.numeric(sampling_set))%>%
  left_join(monet_clay_coord, by = c("proposal_id", "sampling_set"))%>%
  # Resolves longitude mislabeling
  mutate(longitude = if_else(longitude > 0, longitude * -1, longitude))

```

## Join MONet data with Koppen Zones
Extract Koppen climate zones for each MONet sample for comparision across climates regions

# Load in climate zone shapefile
```{r}
# Load the shapefile as an `sf` object
climate_zones_sf <- st_read(paste0(data_dir, "/na_climatezones_shapefile/climatezones_shapefile/NA_ClimateZones/data/North_America_Climate_Zones.shp"))

state_abbreviations_conus <- c(
  "AL", "AZ", "AR", "CA", "CO", 
  "CT", "DE", "FL", "GA", "ID", 
  "IL", "IN", "IA", "KS", "KY", 
  "LA", "ME", "MD", "MA", "MI", 
  "MN", "MS", "MO", "MT", "NE", 
  "NV", "NH", "NJ", "NM", "NY", 
  "NC", "ND", "OH", "OK", "OR", 
  "PA", "RI", "SC", "SD", "TN", 
  "TX", "UT", "VT", "VA", "WA", 
  "WV", "WI", "WY"
)

climate_zone_mapping <- climate_zones_sf%>%
  distinct(Code, Climate)

CONUS_sf <- st_read(paste0(data_dir, "data/s_18mr25/s_18mr25.shp"))%>%
  st_transform(st_crs(climate_zones_sf))%>%
  filter(STATE %in% state_abbreviations_conus)

```

# Convert points to an `sf` object and extract Koppen region information

```{r}

climate_zones_conus_sf <- climate_zones_sf%>%
  st_intersection(st_union(CONUS_sf))

ggplot() +
  geom_sf(data = climate_zones_conus_sf, aes(fill = Climate), color = "black", alpha = 0.5) +
  geom_sf(data = CONUS_sf, color = "red", alpha = 0.3)+
  geom_point(data = )
  labs(title = "Koppen Climate Zones cropped to CONUS") +
  theme(legend.position = "none")

#TODO: check default projection assumption
pH_loc_sf <- st_as_sf(monet_pH_loc, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf)) # transform the projection to koppen zone projection

clay_loc_sf <- st_as_sf(monet_clay_loc, coords = c("longitude", "latitude"), crs = "WGS84")%>%
  st_transform(st_crs(climate_zones_conus_sf))

# Join point data to Koppen shapefile to extract region information for each point
pH_zones <- st_join(pH_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sampling_set, sample, pH, Code, Climate, Key_EN, geometry)

clay_zones <- st_join(clay_loc_sf, climate_zones_conus_sf)%>%
  dplyr::select(proposal_id, sampling_set, sample, Clay_percent, Code, Climate, Key_EN, geometry)

```
  
# Plot distribution of characteristics in each region
```{r}
#TODO Somes values are NA but all should have a designated region
pH_zones%>%
  ggplot(aes(x = pH))+
  geom_boxplot(aes(x = pH, y = Climate))+
  ggtitle("pH distributiton by climate zone")
  theme_bw()

clay_zones%>%
  ggplot(aes(x = Clay_percent, y = Climate))+
  geom_boxplot()+
  ggtitle("Clay content by climate zone")+
  theme_bw()
```
# Read in soilGrids clay content data and clip to CONUS

```{r}
library(tiff)

sg_clay <- rast("crop_roi_igh_clay.tif")

plot(sg_clay)

# This step takes a long time
sg_clay_prj <- sg_clay%>%project(crs(clay_loc_sf))

plot(sg_clay_prj)
```
```{r}

va_sf <- CONUS_sf%>%
  filter(STATE == "VA")


sg_clay_conus <- raster::mask(sg_clay_prj, CONUS_sf)%>%project(crs(clay_loc_sf))

plot(sg_clay_conus)


# Convert the sf object (climate zones) to a terra SpatVector
climate_zones_vect <- vect(climate_zones_conus_sf)

# Mask clay content raster by each climate zone
clay_by_zone <- list()  # Create a list to store masked rasters for each zone

climate_zone_names <- unique(climate_zones_conus_sf$Code)[1:21] # Replace 'zone' with your relevant attribute column

for (zone_name in climate_zone_names) {
  # Filter the specific climate zone
  single_zone <- climate_zones_vect[climate_zones_conus_sf$Code == zone_name, ]
  
  # Mask clay content to just this zone
  clay_zone <- mask(crop(sg_clay_conus, single_zone), single_zone)
  
  # Save the clay raster for this zone
  clay_by_zone[[zone_name]] <- clay_zone
}


# Create a list to store distinct clay content values for each zone
clay_values_by_zone <- list()

for (zone_name in climate_zone_names) {
  # Get the clay content raster for this zone
  clay_zone <- clay_by_zone[[zone_name]]
  
  # Extract cell values as a vector
  clay_values <- unique(values(clay_zone, na.rm = TRUE))  # Remove NA values
  clay_values_by_zone[[zone_name]] <- clay_values         # Store in list
}



clay_zone_df <- data.frame(
  zone = names(clay_values_by_zone),
  clay_content = sapply(clay_values_by_zone, function(x) paste(x, collapse = ", "))
)




clay_long <- do.call(rbind, lapply(names(clay_values_by_zone), function(zone_name) {
  data.frame(zone = zone_name, clay_content = clay_values_by_zone[[zone_name]])
}))

ggplot(clay_long, aes(x = zone, y = crop_roi_igh_clay/10)) +
  geom_boxplot() +
  labs(title = "Clay Content Distribution by Climate Zone",
       x = "Climate Zone", y = "Clay Content") +
  theme_minimal()

clay_values_by_zone


clay_zones%>%
  left_join(climate_zone_mapping, by = c("climate")






sg_clay_conus_sf <- terra::extract(sg_clay_conus, climate_zones_conus_sf)


#sg_clay_conus_sf <- terra::as.polygons(sg_clay_conus)

plot(sg_clay_conus_sf)

clay_zones_sg <- st_join(sg_clay_conus, climate_zones_conus_sf)
```















